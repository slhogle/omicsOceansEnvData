<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Shane Hogle">
<meta name="dcterms.date" content="2025-02-10">

<title>omicOceansEnvData - Download Darwin Biogeochemical model output from Simons CMAP</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<link href="../../site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="../../site_libs/pagedtable-1.1/js/pagedtable.js"></script>


</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../R/tara/01_download_ncbi.html">1. Tara oceans workflow</a></li><li class="breadcrumb-item"><a href="../../R/tara/03_download_darwin.html">3) Darwin model output</a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../../">omicOceansEnvData</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">1. Tara oceans workflow</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../R/tara/01_download_ncbi.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1) BioSamples at NCBI</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../R/tara/02_download_pangaea.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2) Env data at Pangaea.de</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../R/tara/03_download_darwin.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">3) Darwin model output</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../R/tara/04_download_pisces.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4) PISCES model output</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../R/tara/05_harmonize_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5) Harmonize and combine data</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">2. BioGEOTRACES workflow</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../R/biogeotraces/01_download_idp2021.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1) IDP 2021 v2 at Simons CMAP</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">3. HOT/BATS workflow</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../R/hot_bats/01_download_hot_bats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1) HOT/BATS at Simons CMAP</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup"><span class="header-section-number">1</span> Setup</a></li>
  <li><a href="#cmap-database" id="toc-cmap-database" class="nav-link" data-scroll-target="#cmap-database"><span class="header-section-number">2</span> CMAP Database</a>
  <ul class="collapse">
  <li><a href="#api-authorization-to-cmap-sql-database" id="toc-api-authorization-to-cmap-sql-database" class="nav-link" data-scroll-target="#api-authorization-to-cmap-sql-database"><span class="header-section-number">2.1</span> API authorization to CMAP SQL database</a></li>
  <li><a href="#simons-cmap-catalog" id="toc-simons-cmap-catalog" class="nav-link" data-scroll-target="#simons-cmap-catalog"><span class="header-section-number">2.2</span> Simons CMAP catalog</a></li>
  </ul></li>
  <li><a href="#prepare-for-cmap-queries" id="toc-prepare-for-cmap-queries" class="nav-link" data-scroll-target="#prepare-for-cmap-queries"><span class="header-section-number">3</span> Prepare for CMAP queries</a></li>
  <li><a href="#darwin-biogeochemistry-3-day-averaged-model-output" id="toc-darwin-biogeochemistry-3-day-averaged-model-output" class="nav-link" data-scroll-target="#darwin-biogeochemistry-3-day-averaged-model-output"><span class="header-section-number">4</span> Darwin Biogeochemistry 3 Day Averaged model output</a>
  <ul class="collapse">
  <li><a href="#tbldarwin_nutrient" id="toc-tbldarwin_nutrient" class="nav-link" data-scroll-target="#tbldarwin_nutrient"><span class="header-section-number">4.1</span> tblDarwin_Nutrient</a>
  <ul class="collapse">
  <li><a href="#download-full-query-range" id="toc-download-full-query-range" class="nav-link" data-scroll-target="#download-full-query-range"><span class="header-section-number">4.1.1</span> Download full query range</a></li>
  <li><a href="#filter-to-closest-tara-matches" id="toc-filter-to-closest-tara-matches" class="nav-link" data-scroll-target="#filter-to-closest-tara-matches"><span class="header-section-number">4.1.2</span> Filter to closest Tara matches</a></li>
  <li><a href="#save-closest-darwin-grid-coords" id="toc-save-closest-darwin-grid-coords" class="nav-link" data-scroll-target="#save-closest-darwin-grid-coords"><span class="header-section-number">4.1.3</span> Save closest Darwin grid coords</a></li>
  <li><a href="#save-closest-pisces-grid-coords" id="toc-save-closest-pisces-grid-coords" class="nav-link" data-scroll-target="#save-closest-pisces-grid-coords"><span class="header-section-number">4.1.4</span> Save closest PISCES grid coords</a></li>
  </ul></li>
  <li><a href="#tbldarwin_ecosystem" id="toc-tbldarwin_ecosystem" class="nav-link" data-scroll-target="#tbldarwin_ecosystem"><span class="header-section-number">4.2</span> tblDarwin_Ecosystem</a>
  <ul class="collapse">
  <li><a href="#download" id="toc-download" class="nav-link" data-scroll-target="#download"><span class="header-section-number">4.2.1</span> Download</a></li>
  <li><a href="#filtering" id="toc-filtering" class="nav-link" data-scroll-target="#filtering"><span class="header-section-number">4.2.2</span> Filtering</a></li>
  </ul></li>
  <li><a href="#tbldarwin_ocean_color" id="toc-tbldarwin_ocean_color" class="nav-link" data-scroll-target="#tbldarwin_ocean_color"><span class="header-section-number">4.3</span> tblDarwin_Ocean_Color</a>
  <ul class="collapse">
  <li><a href="#download-1" id="toc-download-1" class="nav-link" data-scroll-target="#download-1"><span class="header-section-number">4.3.1</span> Download</a></li>
  <li><a href="#filtering-1" id="toc-filtering-1" class="nav-link" data-scroll-target="#filtering-1"><span class="header-section-number">4.3.2</span> Filtering</a></li>
  </ul></li>
  <li><a href="#tbldarwin_phytoplankton" id="toc-tbldarwin_phytoplankton" class="nav-link" data-scroll-target="#tbldarwin_phytoplankton"><span class="header-section-number">4.4</span> tblDarwin_Phytoplankton</a>
  <ul class="collapse">
  <li><a href="#download-2" id="toc-download-2" class="nav-link" data-scroll-target="#download-2"><span class="header-section-number">4.4.1</span> Download</a></li>
  <li><a href="#filtering-2" id="toc-filtering-2" class="nav-link" data-scroll-target="#filtering-2"><span class="header-section-number">4.4.2</span> Filtering</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#mit-darwin-biogeochemical-model-monthly-climatology-output" id="toc-mit-darwin-biogeochemical-model-monthly-climatology-output" class="nav-link" data-scroll-target="#mit-darwin-biogeochemical-model-monthly-climatology-output"><span class="header-section-number">5</span> MIT Darwin biogeochemical model monthly climatology output</a>
  <ul class="collapse">
  <li><a href="#tbldarwin_nutrient_climatology" id="toc-tbldarwin_nutrient_climatology" class="nav-link" data-scroll-target="#tbldarwin_nutrient_climatology"><span class="header-section-number">5.1</span> tblDarwin_Nutrient_Climatology</a>
  <ul class="collapse">
  <li><a href="#download-3" id="toc-download-3" class="nav-link" data-scroll-target="#download-3"><span class="header-section-number">5.1.1</span> Download</a></li>
  <li><a href="#filtering-3" id="toc-filtering-3" class="nav-link" data-scroll-target="#filtering-3"><span class="header-section-number">5.1.2</span> Filtering</a></li>
  </ul></li>
  <li><a href="#tbldarwin_plankton_climatology" id="toc-tbldarwin_plankton_climatology" class="nav-link" data-scroll-target="#tbldarwin_plankton_climatology"><span class="header-section-number">5.2</span> tblDarwin_Plankton_Climatology</a>
  <ul class="collapse">
  <li><a href="#download-4" id="toc-download-4" class="nav-link" data-scroll-target="#download-4"><span class="header-section-number">5.2.1</span> Download</a></li>
  <li><a href="#filtering-4" id="toc-filtering-4" class="nav-link" data-scroll-target="#filtering-4"><span class="header-section-number">5.2.2</span> Filtering</a></li>
  </ul></li>
  <li><a href="#tbldarwin_chl_climatology" id="toc-tbldarwin_chl_climatology" class="nav-link" data-scroll-target="#tbldarwin_chl_climatology"><span class="header-section-number">5.3</span> tblDarwin_Chl_Climatology</a>
  <ul class="collapse">
  <li><a href="#download-5" id="toc-download-5" class="nav-link" data-scroll-target="#download-5"><span class="header-section-number">5.3.1</span> Download</a></li>
  <li><a href="#filtering-5" id="toc-filtering-5" class="nav-link" data-scroll-target="#filtering-5"><span class="header-section-number">5.3.2</span> Filtering</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../R/tara/01_download_ncbi.html">1. Tara oceans workflow</a></li><li class="breadcrumb-item"><a href="../../R/tara/03_download_darwin.html">3) Darwin model output</a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Download Darwin Biogeochemical model output from Simons CMAP</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Tara Oceans workflow</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Shane Hogle </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 10, 2025</p>
    </div>
  </div>
  
    
  </div>
  
<div>
  <div class="abstract">
    <div class="block-title">Abstract</div>
    Code in this notebook downloads Darwin model outputs from <a href="https://simonscmap.com/">Simons CMAP</a> and stores them locally in the parquet format which is readable by the <a href="https://arrow.apache.org/">Apache Arrow C++ library</a> via the R package <a href="https://arrow.apache.org/docs/r/"><code>arrow</code></a> to allow for fast data access without serialization overhead. This allows us to efficiently work with big data that is too large to fit into working memory - e.g., the entire GEOTRACES IDP2020v1 or the biogeochemical output of PiSCES model.
  </div>
</div>


</header>


<section id="setup" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Setup</h1>
<p>This code loads required libraries and sets global variables</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(here)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(arrow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="cmap-database" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> CMAP Database</h1>
<p><strong>Source:</strong></p>
<ul>
<li><a href="https://simonscmap.com/" class="uri">https://simonscmap.com/</a></li>
</ul>
<p><strong>Reference:</strong></p>
<ul>
<li>Ashkezari MD, Hagen NR, Denholtz M, Neang A, Burns TC, Morales RL, Lee CP, Hill CN, Armbrust EV. 2021. Simons Collaborative Marine Atlas Project (Simons CMAP ): An open‐source portal to share, visualize, and analyze ocean data. Limnol Oceanogr Methods 19:488–496. <a href="https://doi.org/10.1002/lom3.10439" class="uri">https://doi.org/10.1002/lom3.10439</a></li>
</ul>
<section id="api-authorization-to-cmap-sql-database" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="api-authorization-to-cmap-sql-database"><span class="header-section-number">2.1</span> API authorization to CMAP SQL database</h2>
<p>The api key is stored locally (not git tracked) in <code>_notrack/cmap_api.txt</code></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">library</span>(cmap4r)</span>
<span id="cb2-2"><a href="#cb2-2"></a>cmap4r<span class="sc">::</span><span class="fu">set_authorization</span>(<span class="at">reset =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a>cmap4r<span class="sc">::</span><span class="fu">set_authorization</span>(<span class="at">cmap_key =</span> <span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="simons-cmap-catalog" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="simons-cmap-catalog"><span class="header-section-number">2.2</span> Simons CMAP catalog</h2>
<p>Download a local copy of the CMAP catalog. Useful for querying later…</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>local_cat <span class="ot">&lt;-</span> cmap4r<span class="sc">::</span><span class="fu">get_catalog</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="fu">select</span>(Variable, Table_Name, Unit, Sensor, Unit)</span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="fu">write_tsv</span>(local_cat, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"cmap_catalog.tsv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><a href="http://darwinproject.mit.edu/" class="uri">http://darwinproject.mit.edu/</a></p>
<blockquote class="blockquote">
<p>“The Darwin Project is an initiative to advance the development and application of novel models of marine microbes and microbial communities, identifying the relationships of individuals and communities to their environment, connecting cellular-scale processes to global microbial community structure.”</p>
</blockquote>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>local_cat <span class="sc">%&gt;%</span> </span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="fu">filter</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(Table_Name, <span class="st">"(?i)darwin"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="fu">distinct</span>(Table_Name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["Table_Name"],"name":[1],"type":["chr"],"align":["left"]}],"data":[{"1":"tblDarwin_Nutrient_Climatology"},{"1":"tblDarwin_Plankton_Climatology"},{"1":"tblDarwin_Chl_Climatology"},{"1":"tblDarwin_Ecosystem"},{"1":"tblDarwin_Nutrient"},{"1":"tblDarwin_Ocean_Color"},{"1":"tblDarwin_Phytoplankton"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
</section>
<section id="prepare-for-cmap-queries" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Prepare for CMAP queries</h1>
<p><em>Note:</em> These data sets are too big to download from CMAP at once using the provided API because it must read the full data set into memory before writing and the data set size well exceeds the amount of RAM I have on my computer. Therefore, we will first partition Tara samples into their constituent samples/coordinates/times and for each sample we will query the CMAP SQL database for a narrow coordinate range and date range, but the full depth range.</p>
<p>Later we will then subset for the closest depth, coordinate, and time for each sample from each respective program. Then we will combine all these samples into a final data product that we can save for later access.</p>
<p>Read Tara coordinates data.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># data from ncbi</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>tara_biosamples <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_tsv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"pangaea"</span>, <span class="st">"ncbi_mapped_pangaea_barcode.tsv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 1799 Columns: 7
── Column specification ────────────────────────────────────────────────────────
Delimiter: "\t"
chr (7): sra_acc_num, sra_biosample_acc_num, sra_run_acc_num, sra_exp_acc_nu...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># data from pangaea</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>PANGAEA_842237 <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"tara"</span>, <span class="st">"pangaea"</span>, <span class="st">"PANGAEA_842237.parquet"</span>))</span>
<span id="cb7-3"><a href="#cb7-3"></a>PANGAEA_875575 <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"tara"</span>, <span class="st">"pangaea"</span>, <span class="st">"PANGAEA_875575.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This code matches Tara samples coordinates to the nearest grid coordinate in the Darwin output</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>tara2darwin <span class="ot">&lt;-</span> <span class="fu">left_join</span>(tara_biosamples, PANGAEA_875575, <span class="at">by =</span> <span class="fu">join_by</span>(tara_barcode_num, tara_station)) <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="fu">left_join</span>(PANGAEA_842237, <span class="at">by =</span> <span class="fu">join_by</span>(tara_station)) <span class="sc">%&gt;%</span> </span>
<span id="cb8-3"><a href="#cb8-3"></a>  <span class="fu">mutate</span>(<span class="at">depth =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(depth), (depth_min<span class="sc">+</span>depth_max)<span class="sc">/</span><span class="dv">2</span>, depth)) <span class="sc">%&gt;%</span> </span>
<span id="cb8-4"><a href="#cb8-4"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tara_barcode_num, tara_station, latitude, longitude, date_time, depth) <span class="sc">%&gt;%</span> </span>
<span id="cb8-5"><a href="#cb8-5"></a>  <span class="fu">mutate</span>(<span class="at">date_time =</span> lubridate<span class="sc">::</span><span class="fu">as_date</span>(stringr<span class="sc">::</span><span class="fu">str_extract</span>(date_time, <span class="st">"^</span><span class="sc">\\</span><span class="st">d{4}-</span><span class="sc">\\</span><span class="st">d{2}-</span><span class="sc">\\</span><span class="st">d{2}"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb8-6"><a href="#cb8-6"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb8-7"><a href="#cb8-7"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb8-8"><a href="#cb8-8"></a>  <span class="fu">mutate</span>(<span class="at">lat1 =</span> <span class="fu">floor</span>(<span class="fu">first</span>(latitude[<span class="fu">order</span>(latitude)])),</span>
<span id="cb8-9"><a href="#cb8-9"></a>         <span class="at">lat2 =</span> <span class="fu">ceiling</span>(<span class="fu">last</span>(latitude[<span class="fu">order</span>(latitude)])),</span>
<span id="cb8-10"><a href="#cb8-10"></a>         <span class="at">lon1 =</span> <span class="fu">floor</span>(<span class="fu">first</span>(longitude[<span class="fu">order</span>(longitude)])),</span>
<span id="cb8-11"><a href="#cb8-11"></a>         <span class="at">lon2 =</span> <span class="fu">ceiling</span>(<span class="fu">last</span>(longitude[<span class="fu">order</span>(longitude)])),</span>
<span id="cb8-12"><a href="#cb8-12"></a>         <span class="at">dt1 =</span> <span class="fu">floor_date</span>(date_time, <span class="st">'month'</span>),</span>
<span id="cb8-13"><a href="#cb8-13"></a>         <span class="at">dt2 =</span> <span class="fu">ceiling_date</span>(date_time, <span class="st">'month'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb8-14"><a href="#cb8-14"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb8-15"><a href="#cb8-15"></a></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="co"># make nested dataset for initial CMAP query</span></span>
<span id="cb8-17"><a href="#cb8-17"></a>tara2darwin_nest <span class="ot">&lt;-</span> tara2darwin <span class="sc">%&gt;%</span> </span>
<span id="cb8-18"><a href="#cb8-18"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tara_station, latitude, longitude, date_time, lat1, lat2, lon1, lon2, dt1, dt2) <span class="sc">%&gt;%</span>  </span>
<span id="cb8-19"><a href="#cb8-19"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb8-20"><a href="#cb8-20"></a>  tidyr<span class="sc">::</span><span class="fu">nest</span>(<span class="at">dw_query =</span> <span class="sc">-</span>tara_station)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="darwin-biogeochemistry-3-day-averaged-model-output" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Darwin Biogeochemistry 3 Day Averaged model output</h1>
<blockquote class="blockquote">
<p>This dataset contains 3-day averaged model nutrient outputs for the global ocean at 50 depth levels. This version of the model is modified from <a href="https://bg.copernicus.org/articles/12/4447/2015/">Dutkiewicz et al.&nbsp;(2015)</a> and <a href="https://doi.org/10.4319/lo.2012.57.6.1877">Ward et al.&nbsp;(2012)</a>. It includes the biogeochemical cycling of carbon, nitrogen, phosphorus, silica, iron and oxygen, a complex marine ecosystem, incorporating both functional and size diversity of phytoplankton and zooplankton, as well as dissolved organic matter (including an explicit colored component, CDOM), and organic particulate matter. An explicit radiative transfer component and spectral treatment of irradiance provides output that is similar to data provided by ocean color satellite instruments (surface reflectance) and also subsurface optical characteristics such as absorption and scattering. There are 35 phytoplankton types (2 pico-prokaryotes, 2 pico-eukaryotes, 5 coccolithophore, 5 diazotrophs, 11 diatoms, 10 mixotrophic dinoflagellates) and 16 zooplankton types ranging from 0.6µm to 2500 µm equivalent spherical diameter. Parameters influencing growth, grazing, and sinking are related to size (following <a href="https://doi.org/10.4319/lo.2012.57.6.1877">Ward et al.&nbsp;(2012)</a>) with specific differences between functional groups. This simulation uses Monod kinetics, and C:N:P:Fe stoichiometry are constant over time (though do differ between different phytoplankton groups). The zooplankton preferentially graze on plankton 10 times smaller than themselves with a Holling III function. The distributions of the plankton in this model compare well with both observations based on functional types as well as size distributions. We have incorporated distinct absorption and scattering spectra for the different phytoplankton (as in <a href="https://bg.copernicus.org/articles/12/4447/2015/">Dutkiewicz et al.&nbsp;(2015)</a>) as well as flattening of the spectra with size for absorption and scattering. In Darwin_v0.2_cs510, this ecosystem model is driven by the physical ocean model of <a href="https://www.mercator-ocean.eu/wp-content/uploads/2015/06/lettre_31_en.pdf">Menemenlis et al 2008</a> (ECCO2). The grid is a cubed sphere with nominal resolution of 18km such that it is “eddy-permitting” in that it captures eddies and fronts at the mesoscale (order 100km), but not at the sub-mesoscale (order 10kms). Results here have been interpolated to a 0.5 degree grid. The ECCO2 synthesis covers the period 1992– 2015. The physical solution has been obtained using a data constrained Green’s Function approach to estimate initial temperature and salinity conditions, surface boundary conditions, and several empirical ocean and sea ice model parameters. The control parameters include initial temperature and salinity conditions, atmospheric surface boundary conditions, background vertical diffusivity, critical Richardson numbers for the KPP scheme, air-ocean, ice-ocean, air-ice drag coefficients, ice/ocean/snow albedo coefficients, bottom drag, and vertical viscosity. Data constraints include sea level anomaly from altimeter data, time- mean sea level, sea surface temperature, temperature, and salinity profiles from WOCE, TAO, ARGO, XBT, etc., sea ice concentration from passive microwave data, sea ice motion from radiometers, QuikSCAT, and RGPS, and sea ice thickness from ULS. Full depth biogeochemical solutions at native eddying resolutions are available via OpenDAP.</p>
</blockquote>
<section id="tbldarwin_nutrient" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="tbldarwin_nutrient"><span class="header-section-number">4.1</span> tblDarwin_Nutrient</h2>
<p>Source: <a href="https://simonscmap.com/catalog/datasets/Darwin_Nutrient" class="uri">https://simonscmap.com/catalog/datasets/Darwin_Nutrient</a></p>
<section id="download-full-query-range" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="download-full-query-range"><span class="header-section-number">4.1.1</span> Download full query range</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>tara_tblDarwin_Nutrient <span class="ot">&lt;-</span> tara2darwin_nest <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tbl =</span> purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb9-3"><a href="#cb9-3"></a>    dw_query,</span>
<span id="cb9-4"><a href="#cb9-4"></a>    purrr<span class="sc">::</span><span class="fu">slowly</span>(</span>
<span id="cb9-5"><a href="#cb9-5"></a>      <span class="cf">function</span>(df)</span>
<span id="cb9-6"><a href="#cb9-6"></a>        cmap4r<span class="sc">::</span><span class="fu">get_spacetime</span>(</span>
<span id="cb9-7"><a href="#cb9-7"></a>          <span class="at">tableName =</span> <span class="st">'tblDarwin_Nutrient'</span>,</span>
<span id="cb9-8"><a href="#cb9-8"></a>          <span class="at">varName =</span> <span class="st">'*'</span>,</span>
<span id="cb9-9"><a href="#cb9-9"></a>          <span class="at">dt1 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>dt1),</span>
<span id="cb9-10"><a href="#cb9-10"></a>          <span class="at">dt2 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>dt2),</span>
<span id="cb9-11"><a href="#cb9-11"></a>          <span class="at">lat1 =</span> df<span class="sc">$</span>lat1,</span>
<span id="cb9-12"><a href="#cb9-12"></a>          <span class="at">lat2 =</span> df<span class="sc">$</span>lat2,</span>
<span id="cb9-13"><a href="#cb9-13"></a>          <span class="at">lon1 =</span> df<span class="sc">$</span>lon1,</span>
<span id="cb9-14"><a href="#cb9-14"></a>          <span class="at">lon2 =</span> df<span class="sc">$</span>lon2</span>
<span id="cb9-15"><a href="#cb9-15"></a>        ),</span>
<span id="cb9-16"><a href="#cb9-16"></a>      <span class="at">rate =</span> <span class="fu">rate_delay</span>(<span class="dv">3</span>),</span>
<span id="cb9-17"><a href="#cb9-17"></a>      <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb9-18"><a href="#cb9-18"></a>    ),</span>
<span id="cb9-19"><a href="#cb9-19"></a>    <span class="at">.progress =</span> <span class="cn">TRUE</span></span>
<span id="cb9-20"><a href="#cb9-20"></a>  ))</span>
<span id="cb9-21"><a href="#cb9-21"></a></span>
<span id="cb9-22"><a href="#cb9-22"></a>tara_tblDarwin_Nutrient <span class="sc">%&gt;%</span> </span>
<span id="cb9-23"><a href="#cb9-23"></a>  <span class="fu">unnest</span>(<span class="fu">c</span>(tbl, dw_query)) <span class="sc">%&gt;%</span></span>
<span id="cb9-24"><a href="#cb9-24"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">depth_dw =</span> depth, <span class="at">lat_dw=</span>lat, <span class="at">lon_dw=</span>lon, <span class="at">time_dw=</span>time) <span class="sc">%&gt;%</span> </span>
<span id="cb9-25"><a href="#cb9-25"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_station, lat_dw, lon_dw, depth_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb9-26"><a href="#cb9-26"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Nutrient_subset.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="filter-to-closest-tara-matches" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="filter-to-closest-tara-matches"><span class="header-section-number">4.1.2</span> Filter to closest Tara matches</h3>
<p>Filtering Darwin output to only closest matching time, distance, and depth. Difference in times are computed using <code>lubridate</code> package. Distance between two coordinate sets is calculated by the Haversine distance implemented by <code>geosphere::distHaversine</code>. Distance between depths is calculated as a simple difference.</p>
<p>There are two special considerations:</p>
<ol type="1">
<li><p>Some Tara stations are close to land and picking grid points with minimum Haversine distance to the Tara coordinates will end up selecting positions on land. We include a filtering criteria to exclude all Tara grid points that contain only NA values for DIN/PO4/SiOH4 for all depths.</p></li>
<li><p>Tara station TARA_209 is located off of Greenland on the shelf. The sampling depth for the mesopelagic samples is listed as 351 meters. However, in Pangaea datasets the bathymetry depth for this coordinate set is 215 meters. In Darwin (and PISCES) there are no observations at 351 meters, so we instead choose the minimum depth difference between 351 meters and the model depth level with a DIN/PO4/SiOH4 value/.</p></li>
</ol>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>tblDarwin_Nutrient_subset_filt <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Nutrient_subset.parquet"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">time_dw =</span> lubridate<span class="sc">::</span><span class="fu">as_date</span>(stringr<span class="sc">::</span><span class="fu">str_extract</span>(time_dw, <span class="st">"^</span><span class="sc">\\</span><span class="st">d{4}-</span><span class="sc">\\</span><span class="st">d{2}-</span><span class="sc">\\</span><span class="st">d{2}"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="co"># calculate difference in date between darwin and Tara</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tdiff =</span> <span class="fu">abs</span>(time_dw <span class="sc">-</span> date_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-5"><a href="#cb10-5"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(tara_station, latitude, longitude, date_time) <span class="sc">%&gt;%</span> </span>
<span id="cb10-6"><a href="#cb10-6"></a>  <span class="co"># filter to include only darwin time points with smallest time difference to Tara observation </span></span>
<span id="cb10-7"><a href="#cb10-7"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(tdiff <span class="sc">==</span> <span class="fu">min</span>(tdiff)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-8"><a href="#cb10-8"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-9"><a href="#cb10-9"></a>  <span class="co"># remove Darwin grid coords that only contain NA values for DIN (these are either on land or ice)</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(tara_station, lat_dw, lon_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb10-11"><a href="#cb10-11"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">sum</span>(<span class="fu">is.na</span>(DIN)) <span class="sc">!=</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb10-12"><a href="#cb10-12"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-13"><a href="#cb10-13"></a>  dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-14"><a href="#cb10-14"></a>  <span class="co"># calculate Haversine distance (in meters) betwen darwin coord set and Tara coord set</span></span>
<span id="cb10-15"><a href="#cb10-15"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">ddiff =</span> geosphere<span class="sc">::</span><span class="fu">distHaversine</span>(<span class="fu">c</span>(longitude, latitude), <span class="fu">c</span>(lon_dw, lat_dw))) <span class="sc">%&gt;%</span> </span>
<span id="cb10-16"><a href="#cb10-16"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(tara_station, latitude, longitude, date_time) <span class="sc">%&gt;%</span> </span>
<span id="cb10-17"><a href="#cb10-17"></a>  <span class="co"># filter to include only darwin grid point with smallest Haversine distance</span></span>
<span id="cb10-18"><a href="#cb10-18"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(ddiff <span class="sc">==</span> <span class="fu">min</span>(ddiff)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-19"><a href="#cb10-19"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-20"><a href="#cb10-20"></a>  <span class="co"># join back to the full dataset that includes depths for Tara samples. We expect a many2many relationship</span></span>
<span id="cb10-21"><a href="#cb10-21"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(tara2darwin,</span>
<span id="cb10-22"><a href="#cb10-22"></a>                  <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, latitude, longitude, date_time, lat1, lat2, lon1, lon2, dt1, dt2),</span>
<span id="cb10-23"><a href="#cb10-23"></a>                  <span class="at">relationship =</span> <span class="st">"many-to-many"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb10-24"><a href="#cb10-24"></a>  <span class="co"># calculate difference in magnitude between darwin depth and Tara observation</span></span>
<span id="cb10-25"><a href="#cb10-25"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">dpdiff =</span> <span class="fu">abs</span>(depth_dw <span class="sc">-</span> depth)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-26"><a href="#cb10-26"></a>  <span class="co"># filter to only consider Darwin grid points with DIN observations</span></span>
<span id="cb10-27"><a href="#cb10-27"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(DIN)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-28"><a href="#cb10-28"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(tara_station, latitude, longitude, date_time, depth) <span class="sc">%&gt;%</span> </span>
<span id="cb10-29"><a href="#cb10-29"></a>  <span class="co"># filter to include only smallest depth difference</span></span>
<span id="cb10-30"><a href="#cb10-30"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(dpdiff <span class="sc">==</span> <span class="fu">min</span>(dpdiff)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-31"><a href="#cb10-31"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-32"><a href="#cb10-32"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(tara_station, latitude, longitude, date_time, depth) <span class="sc">%&gt;%</span> </span>
<span id="cb10-33"><a href="#cb10-33"></a>  <span class="co"># Some observations have multiple equal depth differences (e.g., target depth is 50 and nearest </span></span>
<span id="cb10-34"><a href="#cb10-34"></a>  <span class="co"># Darwin depths are 45 and 55) this ensures we only take one of them</span></span>
<span id="cb10-35"><a href="#cb10-35"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(depth_dw <span class="sc">==</span> <span class="fu">min</span>(depth_dw)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-36"><a href="#cb10-36"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-37"><a href="#cb10-37"></a>  <span class="co"># recording the difference between Darwin grid point and Tara coords, difference between depths and times</span></span>
<span id="cb10-38"><a href="#cb10-38"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tdiff =</span> lubridate<span class="sc">::</span><span class="fu">make_difftime</span>(tdiff, <span class="at">units =</span> <span class="st">"hours"</span>),</span>
<span id="cb10-39"><a href="#cb10-39"></a>                <span class="at">ddiff =</span> ddiff<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb10-40"><a href="#cb10-40"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">time_diff_hr =</span> tdiff, <span class="at">dist_diff_km =</span> ddiff, <span class="at">depth_diff_m =</span> dpdiff ) <span class="sc">%&gt;%</span> </span>
<span id="cb10-41"><a href="#cb10-41"></a>  <span class="co"># some formatting and cleaning</span></span>
<span id="cb10-42"><a href="#cb10-42"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_barcode_num, tara_station<span class="sc">:</span>longitude, depth, date_time, </span>
<span id="cb10-43"><a href="#cb10-43"></a>                  lat_dw, lon_dw, depth_dw, time_dw, dist_diff_km, depth_diff_m, time_diff_hr) <span class="sc">%&gt;%</span> </span>
<span id="cb10-44"><a href="#cb10-44"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>(lat1<span class="sc">:</span>dt2)) </span>
<span id="cb10-45"><a href="#cb10-45"></a></span>
<span id="cb10-46"><a href="#cb10-46"></a><span class="co"># write output for later</span></span>
<span id="cb10-47"><a href="#cb10-47"></a>arrow<span class="sc">::</span><span class="fu">write_parquet</span>(tblDarwin_Nutrient_subset_filt, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Nutrient_subset_filt.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="save-closest-darwin-grid-coords" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="save-closest-darwin-grid-coords"><span class="header-section-number">4.1.3</span> Save closest Darwin grid coords</h3>
<p>Write 0.25 degree resolved coordinates for later access to Darwin without needing a 1 degree range. It is faster to use exact coords in the API</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>darwin_tara_grid_map <span class="ot">&lt;-</span> tblDarwin_Nutrient_subset_filt <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tara_station<span class="sc">:</span>time_diff_hr) <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3"></a>  <span class="fu">distinct</span>() </span>
<span id="cb11-4"><a href="#cb11-4"></a></span>
<span id="cb11-5"><a href="#cb11-5"></a>arrow<span class="sc">::</span><span class="fu">write_parquet</span>(darwin_tara_grid_map, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"darwin_tara_grid_map.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="save-closest-pisces-grid-coords" class="level3" data-number="4.1.4">
<h3 data-number="4.1.4" class="anchored" data-anchor-id="save-closest-pisces-grid-coords"><span class="header-section-number">4.1.4</span> Save closest PISCES grid coords</h3>
<p>Write 0.25 degree resolved coordinates for later access to PISCES. We’ll use these in the next notebook</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>tblDarwin_Nutrient_subset_filt <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="co"># the only reason I know to set this to 200 is by looking at PISCES output from this grid coords and seeing that </span></span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="co"># the maximum depth was 199 meters</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="fu">mutate</span>(<span class="at">depth =</span> <span class="fu">if_else</span>(tara_station <span class="sc">==</span> <span class="st">"TARA_209"</span> <span class="sc">&amp;</span> depth <span class="sc">==</span> <span class="dv">351</span>, <span class="dv">200</span>, depth)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5"><a href="#cb12-5"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tara_station, <span class="at">lat_cm=</span>lat_dw, latitude, <span class="at">lon_cm=</span>lon_dw, longitude, depth, date_time, dist_diff_km) <span class="sc">%&gt;%</span> </span>
<span id="cb12-6"><a href="#cb12-6"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-7"><a href="#cb12-7"></a>  readr<span class="sc">::</span><span class="fu">write_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"pisces_subsets"</span>, <span class="st">"pisces_tara_grid_map.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="tbldarwin_ecosystem" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="tbldarwin_ecosystem"><span class="header-section-number">4.2</span> tblDarwin_Ecosystem</h2>
<p>Source: <a href="https://simonscmap.com/catalog/datasets/Darwin_Ecosystem" class="uri">https://simonscmap.com/catalog/datasets/Darwin_Ecosystem</a></p>
<p>Now we can use the exact coordinates and dates in our SQL queries to CMAP so that we reduce the amount of data needed to transfer. This version of the variable <code>tara2darwin_nest</code> has the best mapping (i.e.&nbsp;smallest Haversine distance) between the Tara coordinate and the grid in MIT Darwin.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>darwin_tara_grid_map <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"darwin_tara_grid_map.parquet"</span>))</span>
<span id="cb13-2"><a href="#cb13-2"></a></span>
<span id="cb13-3"><a href="#cb13-3"></a>tara2darwin_nest <span class="ot">&lt;-</span> darwin_tara_grid_map <span class="sc">%&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tara_station, lat_dw, lon_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb13-6"><a href="#cb13-6"></a>  tidyr<span class="sc">::</span><span class="fu">nest</span>(<span class="at">dw_query =</span> <span class="sc">-</span>tara_station)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="download" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="download"><span class="header-section-number">4.2.1</span> Download</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>tara_tblDarwin_Ecosystem <span class="ot">&lt;-</span> tara2darwin_nest <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tbl =</span> purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb14-3"><a href="#cb14-3"></a>    dw_query,</span>
<span id="cb14-4"><a href="#cb14-4"></a>    purrr<span class="sc">::</span><span class="fu">slowly</span>(</span>
<span id="cb14-5"><a href="#cb14-5"></a>      <span class="cf">function</span>(df)</span>
<span id="cb14-6"><a href="#cb14-6"></a>        cmap4r<span class="sc">::</span><span class="fu">get_spacetime</span>(</span>
<span id="cb14-7"><a href="#cb14-7"></a>          <span class="at">tableName =</span> <span class="st">'tblDarwin_Ecosystem'</span>,</span>
<span id="cb14-8"><a href="#cb14-8"></a>          <span class="at">varName =</span> <span class="st">'*'</span>,</span>
<span id="cb14-9"><a href="#cb14-9"></a>          <span class="at">dt1 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>time_dw),</span>
<span id="cb14-10"><a href="#cb14-10"></a>          <span class="at">dt2 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>time_dw),</span>
<span id="cb14-11"><a href="#cb14-11"></a>          <span class="at">lat1 =</span> df<span class="sc">$</span>lat_dw,</span>
<span id="cb14-12"><a href="#cb14-12"></a>          <span class="at">lat2 =</span> df<span class="sc">$</span>lat_dw,</span>
<span id="cb14-13"><a href="#cb14-13"></a>          <span class="at">lon1 =</span> df<span class="sc">$</span>lon_dw,</span>
<span id="cb14-14"><a href="#cb14-14"></a>          <span class="at">lon2 =</span> df<span class="sc">$</span>lon_dw</span>
<span id="cb14-15"><a href="#cb14-15"></a>        ),</span>
<span id="cb14-16"><a href="#cb14-16"></a>      <span class="co"># using a 3 second rate delay between calls</span></span>
<span id="cb14-17"><a href="#cb14-17"></a>      <span class="at">rate =</span> <span class="fu">rate_delay</span>(<span class="dv">3</span>),</span>
<span id="cb14-18"><a href="#cb14-18"></a>      <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb14-19"><a href="#cb14-19"></a>    ),</span>
<span id="cb14-20"><a href="#cb14-20"></a>    <span class="at">.progress =</span> <span class="cn">TRUE</span></span>
<span id="cb14-21"><a href="#cb14-21"></a>  ))</span>
<span id="cb14-22"><a href="#cb14-22"></a></span>
<span id="cb14-23"><a href="#cb14-23"></a>tara_tblDarwin_Ecosystem <span class="sc">%&gt;%</span> </span>
<span id="cb14-24"><a href="#cb14-24"></a>  <span class="fu">unnest</span>(<span class="fu">c</span>(tbl)) <span class="sc">%&gt;%</span> </span>
<span id="cb14-25"><a href="#cb14-25"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">time_dw =</span> time, <span class="at">lat_dw =</span> lat, <span class="at">lon_dw =</span> lon, <span class="at">depth_dw =</span> depth) <span class="sc">%&gt;%</span> </span>
<span id="cb14-26"><a href="#cb14-26"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dw_query) <span class="sc">%&gt;%</span> </span>
<span id="cb14-27"><a href="#cb14-27"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Ecosystem_subset.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="filtering" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="filtering"><span class="header-section-number">4.2.2</span> Filtering</h3>
<p>Filtering Darwin output to only closest matching depth. Distance between depths is calculated as a simple difference.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">left_join</span>(darwin_tara_grid_map,</span>
<span id="cb15-2"><a href="#cb15-2"></a>          arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Ecosystem_subset.parquet"</span>)),</span>
<span id="cb15-3"><a href="#cb15-3"></a>          <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, lat_dw, lon_dw, depth_dw, time_dw)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-4"><a href="#cb15-4"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(tara2darwin, <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, latitude, longitude, depth, date_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-5"><a href="#cb15-5"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_barcode_num, tara_station, latitude, longitude, depth, date_time, lat_dw, lon_dw, depth_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb15-6"><a href="#cb15-6"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dist_diff_km, <span class="sc">-</span>depth_diff_m, <span class="sc">-</span>time_diff_hr, <span class="sc">-</span>lat1, <span class="sc">-</span>lat2, <span class="sc">-</span>lon1, <span class="sc">-</span>lon2, <span class="sc">-</span>dt1, <span class="sc">-</span>dt2) <span class="sc">%&gt;%</span> </span>
<span id="cb15-7"><a href="#cb15-7"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Ecosystem_subset_filt.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="tbldarwin_ocean_color" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="tbldarwin_ocean_color"><span class="header-section-number">4.3</span> tblDarwin_Ocean_Color</h2>
<p>Source: <a href="https://simonscmap.com/catalog/datasets/Darwin_Ocean_Color" class="uri">https://simonscmap.com/catalog/datasets/Darwin_Ocean_Color</a></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>darwin_tara_grid_map <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"darwin_tara_grid_map.parquet"</span>))</span>
<span id="cb16-2"><a href="#cb16-2"></a></span>
<span id="cb16-3"><a href="#cb16-3"></a>tara2darwin_nest <span class="ot">&lt;-</span> darwin_tara_grid_map <span class="sc">%&gt;%</span></span>
<span id="cb16-4"><a href="#cb16-4"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tara_station, lat_dw, lon_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb16-5"><a href="#cb16-5"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb16-6"><a href="#cb16-6"></a>  tidyr<span class="sc">::</span><span class="fu">nest</span>(<span class="at">dw_query =</span> <span class="sc">-</span>tara_station)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="download-1" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="download-1"><span class="header-section-number">4.3.1</span> Download</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>tara_tblDarwin_Ocean_Color <span class="ot">&lt;-</span> tara2darwin_nest <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tbl =</span> purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb17-3"><a href="#cb17-3"></a>    dw_query,</span>
<span id="cb17-4"><a href="#cb17-4"></a>    purrr<span class="sc">::</span><span class="fu">slowly</span>(</span>
<span id="cb17-5"><a href="#cb17-5"></a>      <span class="cf">function</span>(df)</span>
<span id="cb17-6"><a href="#cb17-6"></a>        cmap4r<span class="sc">::</span><span class="fu">get_spacetime</span>(</span>
<span id="cb17-7"><a href="#cb17-7"></a>          <span class="at">tableName =</span> <span class="st">'tblDarwin_Ocean_Color'</span>,</span>
<span id="cb17-8"><a href="#cb17-8"></a>          <span class="at">varName =</span> <span class="st">'*'</span>,</span>
<span id="cb17-9"><a href="#cb17-9"></a>          <span class="at">dt1 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>time_dw),</span>
<span id="cb17-10"><a href="#cb17-10"></a>          <span class="at">dt2 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>time_dw),</span>
<span id="cb17-11"><a href="#cb17-11"></a>          <span class="at">lat1 =</span> df<span class="sc">$</span>lat_dw,</span>
<span id="cb17-12"><a href="#cb17-12"></a>          <span class="at">lat2 =</span> df<span class="sc">$</span>lat_dw,</span>
<span id="cb17-13"><a href="#cb17-13"></a>          <span class="at">lon1 =</span> df<span class="sc">$</span>lon_dw,</span>
<span id="cb17-14"><a href="#cb17-14"></a>          <span class="at">lon2 =</span> df<span class="sc">$</span>lon_dw</span>
<span id="cb17-15"><a href="#cb17-15"></a>        ),</span>
<span id="cb17-16"><a href="#cb17-16"></a>      <span class="at">rate =</span> <span class="fu">rate_delay</span>(<span class="dv">3</span>),</span>
<span id="cb17-17"><a href="#cb17-17"></a>      <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb17-18"><a href="#cb17-18"></a>    ),</span>
<span id="cb17-19"><a href="#cb17-19"></a>    <span class="at">.progress =</span> <span class="cn">TRUE</span></span>
<span id="cb17-20"><a href="#cb17-20"></a>  ))</span>
<span id="cb17-21"><a href="#cb17-21"></a></span>
<span id="cb17-22"><a href="#cb17-22"></a>tara_tblDarwin_Ocean_Color <span class="sc">%&gt;%</span></span>
<span id="cb17-23"><a href="#cb17-23"></a>  <span class="fu">unnest</span>(<span class="fu">c</span>(tbl)) <span class="sc">%&gt;%</span> </span>
<span id="cb17-24"><a href="#cb17-24"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">time_dw =</span> time, <span class="at">lat_dw =</span> lat, <span class="at">lon_dw =</span> lon, <span class="at">depth_dw =</span> depth) <span class="sc">%&gt;%</span> </span>
<span id="cb17-25"><a href="#cb17-25"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dw_query) <span class="sc">%&gt;%</span> </span>
<span id="cb17-26"><a href="#cb17-26"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Ocean_Color_subset.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="filtering-1" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="filtering-1"><span class="header-section-number">4.3.2</span> Filtering</h3>
<p>Filtering Darwin output to only closest matching depth. Distance between depths is calculated as a simple difference.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">left_join</span>(darwin_tara_grid_map,</span>
<span id="cb18-2"><a href="#cb18-2"></a>          arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Ocean_Color_subset.parquet"</span>)),</span>
<span id="cb18-3"><a href="#cb18-3"></a>          <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, lat_dw, lon_dw, depth_dw, time_dw)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-4"><a href="#cb18-4"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(tara2darwin, <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, latitude, longitude, depth, date_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-5"><a href="#cb18-5"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_barcode_num, tara_station, latitude, longitude, depth, date_time, lat_dw, lon_dw, depth_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb18-6"><a href="#cb18-6"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dist_diff_km, <span class="sc">-</span>depth_diff_m, <span class="sc">-</span>time_diff_hr, <span class="sc">-</span>lat1, <span class="sc">-</span>lat2, <span class="sc">-</span>lon1, <span class="sc">-</span>lon2, <span class="sc">-</span>dt1, <span class="sc">-</span>dt2) <span class="sc">%&gt;%</span> </span>
<span id="cb18-7"><a href="#cb18-7"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Ocean_Color_subset_filt.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="tbldarwin_phytoplankton" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="tbldarwin_phytoplankton"><span class="header-section-number">4.4</span> tblDarwin_Phytoplankton</h2>
<p>Source: <a href="https://simonscmap.com/catalog/datasets/Darwin_Phytoplankton" class="uri">https://simonscmap.com/catalog/datasets/Darwin_Phytoplankton</a></p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>darwin_tara_grid_map <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"darwin_tara_grid_map.parquet"</span>))</span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a>tara2darwin_nest <span class="ot">&lt;-</span> darwin_tara_grid_map <span class="sc">%&gt;%</span></span>
<span id="cb19-4"><a href="#cb19-4"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tara_station, lat_dw, lon_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb19-6"><a href="#cb19-6"></a>  tidyr<span class="sc">::</span><span class="fu">nest</span>(<span class="at">dw_query =</span> <span class="sc">-</span>tara_station)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="download-2" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="download-2"><span class="header-section-number">4.4.1</span> Download</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>tara_tblDarwin_Phytoplankton <span class="ot">&lt;-</span> tara2darwin_nest <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tbl =</span> purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb20-3"><a href="#cb20-3"></a>    dw_query,</span>
<span id="cb20-4"><a href="#cb20-4"></a>    purrr<span class="sc">::</span><span class="fu">slowly</span>(</span>
<span id="cb20-5"><a href="#cb20-5"></a>      <span class="cf">function</span>(df)</span>
<span id="cb20-6"><a href="#cb20-6"></a>        cmap4r<span class="sc">::</span><span class="fu">get_spacetime</span>(</span>
<span id="cb20-7"><a href="#cb20-7"></a>          <span class="at">tableName =</span> <span class="st">'tblDarwin_Phytoplankton'</span>,</span>
<span id="cb20-8"><a href="#cb20-8"></a>          <span class="at">varName =</span> <span class="st">'*'</span>,</span>
<span id="cb20-9"><a href="#cb20-9"></a>          <span class="at">dt1 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>time_dw),</span>
<span id="cb20-10"><a href="#cb20-10"></a>          <span class="at">dt2 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>time_dw),</span>
<span id="cb20-11"><a href="#cb20-11"></a>          <span class="at">lat1 =</span> df<span class="sc">$</span>lat_dw,</span>
<span id="cb20-12"><a href="#cb20-12"></a>          <span class="at">lat2 =</span> df<span class="sc">$</span>lat_dw,</span>
<span id="cb20-13"><a href="#cb20-13"></a>          <span class="at">lon1 =</span> df<span class="sc">$</span>lon_dw,</span>
<span id="cb20-14"><a href="#cb20-14"></a>          <span class="at">lon2 =</span> df<span class="sc">$</span>lon_dw</span>
<span id="cb20-15"><a href="#cb20-15"></a>        ),</span>
<span id="cb20-16"><a href="#cb20-16"></a>      <span class="at">rate =</span> <span class="fu">rate_delay</span>(<span class="dv">3</span>),</span>
<span id="cb20-17"><a href="#cb20-17"></a>      <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb20-18"><a href="#cb20-18"></a>    ),</span>
<span id="cb20-19"><a href="#cb20-19"></a>    <span class="at">.progress =</span> <span class="cn">TRUE</span></span>
<span id="cb20-20"><a href="#cb20-20"></a>  ))</span>
<span id="cb20-21"><a href="#cb20-21"></a></span>
<span id="cb20-22"><a href="#cb20-22"></a>tara_tblDarwin_Phytoplankton <span class="sc">%&gt;%</span> </span>
<span id="cb20-23"><a href="#cb20-23"></a>  <span class="fu">unnest</span>(<span class="fu">c</span>(tbl)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-24"><a href="#cb20-24"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">time_dw =</span> time, <span class="at">lat_dw =</span> lat, <span class="at">lon_dw =</span> lon, <span class="at">depth_dw =</span> depth) <span class="sc">%&gt;%</span> </span>
<span id="cb20-25"><a href="#cb20-25"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dw_query) <span class="sc">%&gt;%</span> </span>
<span id="cb20-26"><a href="#cb20-26"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Phytoplankton_subset.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="filtering-2" class="level3" data-number="4.4.2">
<h3 data-number="4.4.2" class="anchored" data-anchor-id="filtering-2"><span class="header-section-number">4.4.2</span> Filtering</h3>
<p>Filtering Darwin output to only closest matching depth. Distance between depths is calculated as a simple difference.</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="fu">left_join</span>(darwin_tara_grid_map,</span>
<span id="cb21-2"><a href="#cb21-2"></a>          arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Phytoplankton_subset.parquet"</span>)),</span>
<span id="cb21-3"><a href="#cb21-3"></a>          <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, lat_dw, lon_dw, depth_dw, time_dw)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-4"><a href="#cb21-4"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(tara2darwin, <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, latitude, longitude, depth, date_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-5"><a href="#cb21-5"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_barcode_num, tara_station, latitude, longitude, depth, date_time, lat_dw, lon_dw, depth_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb21-6"><a href="#cb21-6"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dist_diff_km, <span class="sc">-</span>depth_diff_m, <span class="sc">-</span>time_diff_hr, <span class="sc">-</span>lat1, <span class="sc">-</span>lat2, <span class="sc">-</span>lon1, <span class="sc">-</span>lon2, <span class="sc">-</span>dt1, <span class="sc">-</span>dt2) <span class="sc">%&gt;%</span> </span>
<span id="cb21-7"><a href="#cb21-7"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Phytoplankton_subset_filt.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
</section>
<section id="mit-darwin-biogeochemical-model-monthly-climatology-output" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> MIT Darwin biogeochemical model monthly climatology output</h1>
<blockquote class="blockquote">
<p>This version of the model is modified from <a href="https://bg.copernicus.org/articles/12/4447/2015/">Dutkiewicz et al.&nbsp;(2015)</a> and <a href="https://doi.org/10.4319/lo.2012.57.6.1877">Ward et al.&nbsp;(2012)</a>. It includes the biogeochemical cycling of carbon, nitrogen, phosphorus, silica, iron and oxygen, a complex marine ecosystem, incorporating both functional and size diversity of phytoplankton and zooplankton, as well as dissolved organic matter (including an explicit colored component, CDOM), and organic particulate matter. An explicit radiative transfer component and spectral treatment of irradiance provides output that is similar to data provided by ocean color satellite instruments (surface reflectance) and also subsurface optical characteristics such as absorption and scattering. There are 35 phytoplankton types (2 pico-prokaryotes, 2 pico-eukaryotes, 5 coccolithophore, 5 diazotrophs, 11 diatoms, 10 mixotrophic dinoflagellates) and 16 zooplankton types ranging from 0.6µm to 2500 µm equivalent spherical diameter. Parameters influencing growth, grazing, and sinking are related to size (following <a href="https://doi.org/10.4319/lo.2012.57.6.1877">Ward et al.&nbsp;(2012)</a>) with specific differences between functional groups. This simulation uses Monod kinetics, and C:N:P:Fe stoichiometry are constant over time (though do differ between different phytoplankton groups). The zooplankton preferentially graze on plankton 10 times smaller than themselves with a Holling III function. The distributions of the plankton in this model compare well with both observations based on functional types as well as size distributions. We have incorporated distinct absorption and scattering spectra for the different phytoplankton (as in <a href="https://bg.copernicus.org/articles/12/4447/2015/">Dutkiewicz et al.&nbsp;(2015)</a>) as well as flattening of the spectra with size for absorption and scattering. In Darwin_v0.1_llc90, this ecosystem model is driven by the physical ocean model of <a href="https://doi.org/10.5194/gmd-8-3071-2015,%202015">Forget et al, 2015</a> (ECCO version 4, <a href="https://eccov4.readthedocs.io" class="uri">https://eccov4.readthedocs.io</a>) which runs on a 1-degree, global grid called LLC90 (<a href="https://doi.org/10.5194/gmd-8-3071-2015,%202015">Forget et al, 2015</a>). This physical ocean model benefits from optimized parameterizations (small- and meso-scale turbulence) and atmospheric boundary conditions (air-sea fluxes). As a result, it matches in-situ observations (T, S, MLD, etc.) and remote sensing data (SST, altimetry, etc.) better than earlier ECCO solutions do (Forget, Ferreira, Liang 2015, Forget and Ponte 2015). Another advantage of this model configuration is that it is easy and inexpensive to re-run in order to produce more output or to experiment with the ecosystem and physical model settings (Forget 2018, 2019, <a href="https://cbiomes.readthedocs.io" class="uri">https://cbiomes.readthedocs.io</a>). Results here have been interpolated to a 0.5 degree grid.</p>
</blockquote>
<p>Source: <a href="https://simonscmap.com/catalog/datasets/Darwin-MITgcm_Climatology" class="uri">https://simonscmap.com/catalog/datasets/Darwin-MITgcm_Climatology</a></p>
<p><strong>Note:</strong> This output is the averaged monthly climatology and only includes values averaged over the model’s monthly time steps. This model output is small enough that we can download it for the entire ocean, save the product, and access it later if needed</p>
<section id="tbldarwin_nutrient_climatology" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="tbldarwin_nutrient_climatology"><span class="header-section-number">5.1</span> tblDarwin_Nutrient_Climatology</h2>
<p>Source: <a href="https://simonscmap.com/catalog/datasets/Darwin-MITgcm_Climatology" class="uri">https://simonscmap.com/catalog/datasets/Darwin-MITgcm_Climatology</a></p>
<section id="download-3" class="level3" data-number="5.1.1">
<h3 data-number="5.1.1" class="anchored" data-anchor-id="download-3"><span class="header-section-number">5.1.1</span> Download</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>tblDarwin_Nutrient_Climatology <span class="ot">&lt;-</span> cmap4r<span class="sc">::</span><span class="fu">get_spacetime</span>(</span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="at">tableName =</span> <span class="st">"tblDarwin_Nutrient_Climatology"</span>,</span>
<span id="cb22-3"><a href="#cb22-3"></a>  <span class="at">varName =</span> <span class="st">"*"</span>,</span>
<span id="cb22-4"><a href="#cb22-4"></a>  <span class="at">dt1 =</span> <span class="st">""</span>,</span>
<span id="cb22-5"><a href="#cb22-5"></a>  <span class="at">dt2 =</span> <span class="st">""</span>,</span>
<span id="cb22-6"><a href="#cb22-6"></a>  <span class="at">lat1 =</span> <span class="sc">-</span><span class="dv">90</span>,</span>
<span id="cb22-7"><a href="#cb22-7"></a>  <span class="at">lat2 =</span> <span class="dv">90</span>,</span>
<span id="cb22-8"><a href="#cb22-8"></a>  <span class="at">lon1 =</span> <span class="sc">-</span><span class="dv">180</span>,</span>
<span id="cb22-9"><a href="#cb22-9"></a>  <span class="at">lon2 =</span> <span class="dv">180</span></span>
<span id="cb22-10"><a href="#cb22-10"></a>)</span>
<span id="cb22-11"><a href="#cb22-11"></a></span>
<span id="cb22-12"><a href="#cb22-12"></a>tblDarwin_Nutrient_Climatology <span class="sc">%&gt;%</span> </span>
<span id="cb22-13"><a href="#cb22-13"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">lat_dw =</span> lat, <span class="at">lon_dw =</span> lon, <span class="at">depth_dw =</span> depth) <span class="sc">%&gt;%</span> </span>
<span id="cb22-14"><a href="#cb22-14"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"darwin"</span>, <span class="st">"tblDarwin_Nutrient_Climatology.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="filtering-3" class="level3" data-number="5.1.2">
<h3 data-number="5.1.2" class="anchored" data-anchor-id="filtering-3"><span class="header-section-number">5.1.2</span> Filtering</h3>
<p>Filtering Darwin output to only closest matching depth. We use the “Tara to Darwin grid mapping” derived earlier. Distance between depths is calculated as the magnitude of their difference.</p>
<p>Something seriously weird is happening - I should be able to join on <code>depth_dw</code> variable in both datasets but for some cases NAs are produced when there is not missing data in the Darwin climatology data. <a href="https://stackoverflow.com/questions/46487199/r-dplyr-left-join-error-missing-values-produced-when-joining-values-rounded-to">Note issue here</a> on joining by numbers. Apparently better to convert to string first?</p>
<p>Note: also something weird going on with TARA_206 at depth 411. In the 3-day average Darwin model these values are not missing, but they are missing in the climatology</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>darwin_tara_grid_map <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"darwin_tara_grid_map.parquet"</span>))</span>
<span id="cb23-2"><a href="#cb23-2"></a></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="fu">left_join</span>(darwin_tara_grid_map,</span>
<span id="cb23-4"><a href="#cb23-4"></a>          arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"darwin"</span>, <span class="st">"tblDarwin_Nutrient_Climatology.parquet"</span>)),</span>
<span id="cb23-5"><a href="#cb23-5"></a>          <span class="at">by =</span> <span class="fu">join_by</span>(lat_dw, lon_dw),</span>
<span id="cb23-6"><a href="#cb23-6"></a>          <span class="at">relationship =</span> <span class="st">"many-to-many"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7"></a>  <span class="fu">group_by</span>(tara_station, lat_dw, lon_dw, depth_dw.x) <span class="sc">%&gt;%</span> </span>
<span id="cb23-8"><a href="#cb23-8"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(depth_dw.x<span class="sc">-</span>depth_dw.y) <span class="sc">==</span> <span class="fu">min</span>(<span class="fu">abs</span>(depth_dw.x<span class="sc">-</span>depth_dw.y))) <span class="sc">%&gt;%</span> </span>
<span id="cb23-9"><a href="#cb23-9"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb23-10"><a href="#cb23-10"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(tara2darwin, <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, latitude, longitude, depth, date_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-11"><a href="#cb23-11"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_barcode_num, tara_station, latitude, longitude, depth, date_time, lat_dw, lon_dw, depth_dw.x, time_dw) <span class="sc">%&gt;%</span></span>
<span id="cb23-12"><a href="#cb23-12"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">depth_dw =</span> depth_dw.x) <span class="sc">%&gt;%</span> </span>
<span id="cb23-13"><a href="#cb23-13"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dist_diff_km, <span class="sc">-</span>depth_diff_m, <span class="sc">-</span>time_diff_hr, <span class="sc">-</span>lat1, <span class="sc">-</span>lat2, <span class="sc">-</span>lon1, <span class="sc">-</span>lon2, <span class="sc">-</span>dt1, <span class="sc">-</span>dt2) <span class="sc">%&gt;%</span> </span>
<span id="cb23-14"><a href="#cb23-14"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Nutrient_Climatology_subset_filt.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="tbldarwin_plankton_climatology" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="tbldarwin_plankton_climatology"><span class="header-section-number">5.2</span> tblDarwin_Plankton_Climatology</h2>
<p>Source: <a href="https://simonscmap.com/catalog/datasets/Darwin-MITgcm_Climatology" class="uri">https://simonscmap.com/catalog/datasets/Darwin-MITgcm_Climatology</a></p>
<section id="download-4" class="level3" data-number="5.2.1">
<h3 data-number="5.2.1" class="anchored" data-anchor-id="download-4"><span class="header-section-number">5.2.1</span> Download</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>tblDarwin_Plankton_Climatology <span class="ot">&lt;-</span> cmap4r<span class="sc">::</span><span class="fu">get_spacetime</span>(</span>
<span id="cb24-2"><a href="#cb24-2"></a>  <span class="at">tableName =</span> <span class="st">"tblDarwin_Plankton_Climatology"</span>,</span>
<span id="cb24-3"><a href="#cb24-3"></a>  <span class="at">varName =</span> <span class="st">"*"</span>,</span>
<span id="cb24-4"><a href="#cb24-4"></a>  <span class="at">dt1 =</span> <span class="st">""</span>,</span>
<span id="cb24-5"><a href="#cb24-5"></a>  <span class="at">dt2 =</span> <span class="st">""</span>,</span>
<span id="cb24-6"><a href="#cb24-6"></a>  <span class="at">lat1 =</span> <span class="sc">-</span><span class="dv">90</span>,</span>
<span id="cb24-7"><a href="#cb24-7"></a>  <span class="at">lat2 =</span> <span class="dv">90</span>,</span>
<span id="cb24-8"><a href="#cb24-8"></a>  <span class="at">lon1 =</span> <span class="sc">-</span><span class="dv">180</span>,</span>
<span id="cb24-9"><a href="#cb24-9"></a>  <span class="at">lon2 =</span> <span class="dv">180</span></span>
<span id="cb24-10"><a href="#cb24-10"></a>)</span>
<span id="cb24-11"><a href="#cb24-11"></a></span>
<span id="cb24-12"><a href="#cb24-12"></a>tblDarwin_Plankton_Climatology <span class="sc">%&gt;%</span> </span>
<span id="cb24-13"><a href="#cb24-13"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">lat_dw =</span> lat, <span class="at">lon_dw =</span> lon, <span class="at">depth_dw =</span> depth) <span class="sc">%&gt;%</span> </span>
<span id="cb24-14"><a href="#cb24-14"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"darwin"</span>, <span class="st">"tblDarwin_Plankton_Climatology.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="filtering-4" class="level3" data-number="5.2.2">
<h3 data-number="5.2.2" class="anchored" data-anchor-id="filtering-4"><span class="header-section-number">5.2.2</span> Filtering</h3>
<p>Filtering Darwin output to only closest matching depth. We use the “Tara to Darwin grid mapping” derived earlier. Distance between depths is calculated as the magnitude of their difference.</p>
<p>Something seriously weird is happening - I should be able to join on <code>depth_dw</code> variable in both datasets but for some cases NAs are produced when there is not missing data in the Darwin climatology data. <a href="https://stackoverflow.com/questions/46487199/r-dplyr-left-join-error-missing-values-produced-when-joining-values-rounded-to">Note issue here</a> on joining by numbers. Apparently better to convert to string first?</p>
<p>Note: also something weird going on with TARA_206 at depth 411. In the 3-day average Darwin model these values are not missing, but they are missing in the climatology</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>darwin_tara_grid_map <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"darwin_tara_grid_map.parquet"</span>))</span>
<span id="cb25-2"><a href="#cb25-2"></a></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="fu">left_join</span>(darwin_tara_grid_map,</span>
<span id="cb25-4"><a href="#cb25-4"></a>          arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"darwin"</span>, <span class="st">"tblDarwin_Plankton_Climatology.parquet"</span>)),</span>
<span id="cb25-5"><a href="#cb25-5"></a>          <span class="at">by =</span> <span class="fu">join_by</span>(lat_dw, lon_dw),</span>
<span id="cb25-6"><a href="#cb25-6"></a>          <span class="at">relationship =</span> <span class="st">"many-to-many"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-7"><a href="#cb25-7"></a>  <span class="fu">group_by</span>(tara_station, lat_dw, lon_dw, depth_dw.x) <span class="sc">%&gt;%</span> </span>
<span id="cb25-8"><a href="#cb25-8"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(depth_dw.x<span class="sc">-</span>depth_dw.y) <span class="sc">==</span> <span class="fu">min</span>(<span class="fu">abs</span>(depth_dw.x<span class="sc">-</span>depth_dw.y))) <span class="sc">%&gt;%</span> </span>
<span id="cb25-9"><a href="#cb25-9"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb25-10"><a href="#cb25-10"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(tara2darwin, <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, latitude, longitude, depth, date_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb25-11"><a href="#cb25-11"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_barcode_num, tara_station, latitude, longitude, depth, date_time, lat_dw, lon_dw, depth_dw.x, time_dw) <span class="sc">%&gt;%</span></span>
<span id="cb25-12"><a href="#cb25-12"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">depth_dw =</span> depth_dw.x) <span class="sc">%&gt;%</span> </span>
<span id="cb25-13"><a href="#cb25-13"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dist_diff_km, <span class="sc">-</span>depth_diff_m, <span class="sc">-</span>time_diff_hr, <span class="sc">-</span>lat1, <span class="sc">-</span>lat2, <span class="sc">-</span>lon1, <span class="sc">-</span>lon2, <span class="sc">-</span>dt1, <span class="sc">-</span>dt2) <span class="sc">%&gt;%</span> </span>
<span id="cb25-14"><a href="#cb25-14"></a>  <span class="co">#filter(if_any(everything(), ~is.na(.)))</span></span>
<span id="cb25-15"><a href="#cb25-15"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Plankton_Climatology_subset_filt.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="tbldarwin_chl_climatology" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="tbldarwin_chl_climatology"><span class="header-section-number">5.3</span> tblDarwin_Chl_Climatology</h2>
<p>Source: <a href="https://simonscmap.com/catalog/datasets/Darwin-MITgcm_Climatology" class="uri">https://simonscmap.com/catalog/datasets/Darwin-MITgcm_Climatology</a></p>
<section id="download-5" class="level3" data-number="5.3.1">
<h3 data-number="5.3.1" class="anchored" data-anchor-id="download-5"><span class="header-section-number">5.3.1</span> Download</h3>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>tblDarwin_Chl_Climatology <span class="ot">&lt;-</span> cmap4r<span class="sc">::</span><span class="fu">get_spacetime</span>(</span>
<span id="cb26-2"><a href="#cb26-2"></a>  <span class="at">tableName =</span> <span class="st">"tblDarwin_Chl_Climatology"</span>,</span>
<span id="cb26-3"><a href="#cb26-3"></a>  <span class="at">varName =</span> <span class="st">"*"</span>,</span>
<span id="cb26-4"><a href="#cb26-4"></a>  <span class="at">dt1 =</span> <span class="st">""</span>,</span>
<span id="cb26-5"><a href="#cb26-5"></a>  <span class="at">dt2 =</span> <span class="st">""</span>,</span>
<span id="cb26-6"><a href="#cb26-6"></a>  <span class="at">lat1 =</span> <span class="sc">-</span><span class="dv">90</span>,</span>
<span id="cb26-7"><a href="#cb26-7"></a>  <span class="at">lat2 =</span> <span class="dv">90</span>,</span>
<span id="cb26-8"><a href="#cb26-8"></a>  <span class="at">lon1 =</span> <span class="sc">-</span><span class="dv">180</span>,</span>
<span id="cb26-9"><a href="#cb26-9"></a>  <span class="at">lon2 =</span> <span class="dv">180</span></span>
<span id="cb26-10"><a href="#cb26-10"></a>)</span>
<span id="cb26-11"><a href="#cb26-11"></a></span>
<span id="cb26-12"><a href="#cb26-12"></a>tblDarwin_Chl_Climatology <span class="sc">%&gt;%</span> </span>
<span id="cb26-13"><a href="#cb26-13"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">lat_dw =</span> lat, <span class="at">lon_dw =</span> lon, <span class="at">depth_dw =</span> depth) <span class="sc">%&gt;%</span> </span>
<span id="cb26-14"><a href="#cb26-14"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"darwin"</span>, <span class="st">"tblDarwin_Chl_Climatology.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="filtering-5" class="level3" data-number="5.3.2">
<h3 data-number="5.3.2" class="anchored" data-anchor-id="filtering-5"><span class="header-section-number">5.3.2</span> Filtering</h3>
<p>Filtering Darwin output to only closest matching depth. We use the “Tara to Darwin grid mapping” derived earlier. Distance between depths is calculated as the magnitude of their difference.</p>
<p>Something seriously weird is happening - I should be able to join on <code>depth_dw</code> variable in both datasets but for some cases NAs are produced when there is not missing data in the Darwin climatology data. <a href="https://stackoverflow.com/questions/46487199/r-dplyr-left-join-error-missing-values-produced-when-joining-values-rounded-to">Note issue here</a> on joining by numbers. Apparently better to convert to string first?</p>
<p>Note: also something weird going on with TARA_206 at depth 411. In the 3-day average Darwin model these values are not missing, but they are missing in the climatology</p>
<div class="cell">
<details open="" class="code-fold">
<summary>Show/hide code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>darwin_tara_grid_map <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"darwin_tara_grid_map.parquet"</span>))</span>
<span id="cb27-2"><a href="#cb27-2"></a></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="fu">left_join</span>(darwin_tara_grid_map,</span>
<span id="cb27-4"><a href="#cb27-4"></a>          arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"darwin"</span>, <span class="st">"tblDarwin_Chl_Climatology.parquet"</span>)),</span>
<span id="cb27-5"><a href="#cb27-5"></a>          <span class="at">by =</span> <span class="fu">join_by</span>(lat_dw, lon_dw),</span>
<span id="cb27-6"><a href="#cb27-6"></a>          <span class="at">relationship =</span> <span class="st">"many-to-many"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-7"><a href="#cb27-7"></a>  <span class="fu">group_by</span>(tara_station, lat_dw, lon_dw, depth_dw.x) <span class="sc">%&gt;%</span> </span>
<span id="cb27-8"><a href="#cb27-8"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(depth_dw.x<span class="sc">-</span>depth_dw.y) <span class="sc">==</span> <span class="fu">min</span>(<span class="fu">abs</span>(depth_dw.x<span class="sc">-</span>depth_dw.y))) <span class="sc">%&gt;%</span> </span>
<span id="cb27-9"><a href="#cb27-9"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb27-10"><a href="#cb27-10"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(tara2darwin, <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, latitude, longitude, depth, date_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb27-11"><a href="#cb27-11"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_barcode_num, tara_station, latitude, longitude, depth, date_time, lat_dw, lon_dw, depth_dw.x, time_dw) <span class="sc">%&gt;%</span></span>
<span id="cb27-12"><a href="#cb27-12"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">depth_dw =</span> depth_dw.x) <span class="sc">%&gt;%</span> </span>
<span id="cb27-13"><a href="#cb27-13"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dist_diff_km, <span class="sc">-</span>depth_diff_m, <span class="sc">-</span>time_diff_hr, <span class="sc">-</span>lat1, <span class="sc">-</span>lat2, <span class="sc">-</span>lon1, <span class="sc">-</span>lon2, <span class="sc">-</span>dt1, <span class="sc">-</span>dt2) <span class="sc">%&gt;%</span> </span>
<span id="cb27-14"><a href="#cb27-14"></a>  <span class="co">#filter(if_any(everything(), ~is.na(.)))</span></span>
<span id="cb27-15"><a href="#cb27-15"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Chl_Climatology_subset_filt.parquet"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


<!-- -->

</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb28" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb28-1"><a href="#cb28-1"></a><span class="co">---</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="an">title:</span><span class="co"> "Download Darwin Biogeochemical model output from Simons CMAP"</span></span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="an">subtitle:</span><span class="co"> "Tara Oceans workflow"</span></span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="an">author:</span><span class="co"> "Shane Hogle"</span></span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="an">date:</span><span class="co"> today</span></span>
<span id="cb28-6"><a href="#cb28-6"></a><span class="an">abstract:</span><span class="co"> "Code in this notebook downloads Darwin model outputs from [Simons CMAP](https://simonscmap.com/) and stores them locally in the parquet format which is readable by the [Apache Arrow C++ library](https://arrow.apache.org/) via the R package [`arrow`](https://arrow.apache.org/docs/r/) to allow for fast data access without serialization overhead. This allows us to efficiently work with big data that is too large to fit into working memory - e.g., the entire GEOTRACES IDP2020v1 or the biogeochemical output of PiSCES model."</span></span>
<span id="cb28-7"><a href="#cb28-7"></a><span class="co">---</span></span>
<span id="cb28-8"><a href="#cb28-8"></a></span>
<span id="cb28-9"><a href="#cb28-9"></a><span class="fu"># Setup</span></span>
<span id="cb28-10"><a href="#cb28-10"></a></span>
<span id="cb28-11"><a href="#cb28-11"></a>This code loads required libraries and sets global variables</span>
<span id="cb28-12"><a href="#cb28-12"></a></span>
<span id="cb28-15"><a href="#cb28-15"></a><span class="in">```{r}</span></span>
<span id="cb28-16"><a href="#cb28-16"></a><span class="co">#| output: false</span></span>
<span id="cb28-17"><a href="#cb28-17"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb28-18"><a href="#cb28-18"></a><span class="fu">library</span>(readxl)</span>
<span id="cb28-19"><a href="#cb28-19"></a><span class="fu">library</span>(here)</span>
<span id="cb28-20"><a href="#cb28-20"></a><span class="fu">library</span>(arrow)</span>
<span id="cb28-21"><a href="#cb28-21"></a><span class="in">```</span></span>
<span id="cb28-22"><a href="#cb28-22"></a></span>
<span id="cb28-23"><a href="#cb28-23"></a><span class="fu"># CMAP Database</span></span>
<span id="cb28-24"><a href="#cb28-24"></a></span>
<span id="cb28-25"><a href="#cb28-25"></a>**Source:**</span>
<span id="cb28-26"><a href="#cb28-26"></a></span>
<span id="cb28-27"><a href="#cb28-27"></a><span class="ss">-   </span><span class="ot">&lt;https://simonscmap.com/&gt;</span></span>
<span id="cb28-28"><a href="#cb28-28"></a></span>
<span id="cb28-29"><a href="#cb28-29"></a>**Reference:**</span>
<span id="cb28-30"><a href="#cb28-30"></a></span>
<span id="cb28-31"><a href="#cb28-31"></a><span class="ss">-   </span>Ashkezari MD, Hagen NR, Denholtz M, Neang A, Burns TC, Morales RL, Lee CP, Hill CN, Armbrust EV. 2021. Simons Collaborative Marine Atlas Project (Simons CMAP ): An open‐source portal to share, visualize, and analyze ocean data. Limnol Oceanogr Methods 19:488–496. <span class="ot">&lt;https://doi.org/10.1002/lom3.10439&gt;</span></span>
<span id="cb28-32"><a href="#cb28-32"></a></span>
<span id="cb28-33"><a href="#cb28-33"></a><span class="fu">## API authorization to CMAP SQL database</span></span>
<span id="cb28-34"><a href="#cb28-34"></a></span>
<span id="cb28-35"><a href="#cb28-35"></a>The api key is stored locally (not git tracked) in <span class="in">`_notrack/cmap_api.txt`</span></span>
<span id="cb28-36"><a href="#cb28-36"></a></span>
<span id="cb28-39"><a href="#cb28-39"></a><span class="in">```{r}</span></span>
<span id="cb28-40"><a href="#cb28-40"></a><span class="co">#| echo: true</span></span>
<span id="cb28-41"><a href="#cb28-41"></a><span class="co">#| eval: false</span></span>
<span id="cb28-42"><a href="#cb28-42"></a><span class="co">#| output: false</span></span>
<span id="cb28-43"><a href="#cb28-43"></a><span class="fu">library</span>(cmap4r)</span>
<span id="cb28-44"><a href="#cb28-44"></a>cmap4r<span class="sc">::</span><span class="fu">set_authorization</span>(<span class="at">reset =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-45"><a href="#cb28-45"></a>cmap4r<span class="sc">::</span><span class="fu">set_authorization</span>(<span class="at">cmap_key =</span> <span class="st">""</span>)</span>
<span id="cb28-46"><a href="#cb28-46"></a><span class="in">```</span></span>
<span id="cb28-47"><a href="#cb28-47"></a></span>
<span id="cb28-48"><a href="#cb28-48"></a><span class="fu">## Simons CMAP catalog</span></span>
<span id="cb28-49"><a href="#cb28-49"></a></span>
<span id="cb28-50"><a href="#cb28-50"></a>Download a local copy of the CMAP catalog. Useful for querying later...</span>
<span id="cb28-51"><a href="#cb28-51"></a></span>
<span id="cb28-54"><a href="#cb28-54"></a><span class="in">```{r}</span></span>
<span id="cb28-55"><a href="#cb28-55"></a><span class="co">#| echo: true</span></span>
<span id="cb28-56"><a href="#cb28-56"></a><span class="co">#| eval: false</span></span>
<span id="cb28-57"><a href="#cb28-57"></a><span class="co">#| output: false</span></span>
<span id="cb28-58"><a href="#cb28-58"></a>local_cat <span class="ot">&lt;-</span> cmap4r<span class="sc">::</span><span class="fu">get_catalog</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-59"><a href="#cb28-59"></a>  <span class="fu">select</span>(Variable, Table_Name, Unit, Sensor, Unit)</span>
<span id="cb28-60"><a href="#cb28-60"></a></span>
<span id="cb28-61"><a href="#cb28-61"></a><span class="fu">write_tsv</span>(local_cat, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"cmap_catalog.tsv"</span>))</span>
<span id="cb28-62"><a href="#cb28-62"></a><span class="in">```</span></span>
<span id="cb28-63"><a href="#cb28-63"></a></span>
<span id="cb28-66"><a href="#cb28-66"></a><span class="in">```{r}</span></span>
<span id="cb28-67"><a href="#cb28-67"></a><span class="co">#| echo: false</span></span>
<span id="cb28-68"><a href="#cb28-68"></a><span class="co">#| eval: true</span></span>
<span id="cb28-69"><a href="#cb28-69"></a><span class="co">#| output: false</span></span>
<span id="cb28-70"><a href="#cb28-70"></a>local_cat <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"cmap_catalog.tsv"</span>))</span>
<span id="cb28-71"><a href="#cb28-71"></a><span class="in">```</span></span>
<span id="cb28-72"><a href="#cb28-72"></a></span>
<span id="cb28-73"><a href="#cb28-73"></a><span class="ot">&lt;http://darwinproject.mit.edu/&gt;</span></span>
<span id="cb28-74"><a href="#cb28-74"></a></span>
<span id="cb28-75"><a href="#cb28-75"></a><span class="at">&gt; "The Darwin Project is an initiative to advance the development and application of novel models of marine microbes and microbial communities, identifying the relationships of individuals and communities to their environment, connecting cellular-scale processes to global microbial community structure."</span></span>
<span id="cb28-76"><a href="#cb28-76"></a></span>
<span id="cb28-79"><a href="#cb28-79"></a><span class="in">```{r}</span></span>
<span id="cb28-80"><a href="#cb28-80"></a>local_cat <span class="sc">%&gt;%</span> </span>
<span id="cb28-81"><a href="#cb28-81"></a>  <span class="fu">filter</span>(stringr<span class="sc">::</span><span class="fu">str_detect</span>(Table_Name, <span class="st">"(?i)darwin"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-82"><a href="#cb28-82"></a>  <span class="fu">distinct</span>(Table_Name)</span>
<span id="cb28-83"><a href="#cb28-83"></a><span class="in">```</span></span>
<span id="cb28-84"><a href="#cb28-84"></a></span>
<span id="cb28-85"><a href="#cb28-85"></a><span class="fu"># Prepare for CMAP queries</span></span>
<span id="cb28-86"><a href="#cb28-86"></a></span>
<span id="cb28-87"><a href="#cb28-87"></a>*Note:* These data sets are too big to download from CMAP at once using the provided API because it must read the full data set into memory before writing and the data set size well exceeds the amount of RAM I have on my computer. Therefore, we will first partition Tara samples into their constituent samples/coordinates/times and for each sample we will query the CMAP SQL database for a narrow coordinate range and date range, but the full depth range.</span>
<span id="cb28-88"><a href="#cb28-88"></a></span>
<span id="cb28-89"><a href="#cb28-89"></a>Later we will then subset for the closest depth, coordinate, and time for each sample from each respective program. Then we will combine all these samples into a final data product that we can save for later access.</span>
<span id="cb28-90"><a href="#cb28-90"></a></span>
<span id="cb28-91"><a href="#cb28-91"></a>Read Tara coordinates data.</span>
<span id="cb28-92"><a href="#cb28-92"></a></span>
<span id="cb28-95"><a href="#cb28-95"></a><span class="in">```{r}</span></span>
<span id="cb28-96"><a href="#cb28-96"></a><span class="co"># data from ncbi</span></span>
<span id="cb28-97"><a href="#cb28-97"></a>tara_biosamples <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_tsv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"pangaea"</span>, <span class="st">"ncbi_mapped_pangaea_barcode.tsv"</span>))</span>
<span id="cb28-98"><a href="#cb28-98"></a></span>
<span id="cb28-99"><a href="#cb28-99"></a><span class="co"># data from pangaea</span></span>
<span id="cb28-100"><a href="#cb28-100"></a>PANGAEA_842237 <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"tara"</span>, <span class="st">"pangaea"</span>, <span class="st">"PANGAEA_842237.parquet"</span>))</span>
<span id="cb28-101"><a href="#cb28-101"></a>PANGAEA_875575 <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"tara"</span>, <span class="st">"pangaea"</span>, <span class="st">"PANGAEA_875575.parquet"</span>))</span>
<span id="cb28-102"><a href="#cb28-102"></a><span class="in">```</span></span>
<span id="cb28-103"><a href="#cb28-103"></a></span>
<span id="cb28-104"><a href="#cb28-104"></a>This code matches Tara samples coordinates to the nearest grid coordinate in the Darwin output</span>
<span id="cb28-105"><a href="#cb28-105"></a></span>
<span id="cb28-108"><a href="#cb28-108"></a><span class="in">```{r}</span></span>
<span id="cb28-109"><a href="#cb28-109"></a>tara2darwin <span class="ot">&lt;-</span> <span class="fu">left_join</span>(tara_biosamples, PANGAEA_875575, <span class="at">by =</span> <span class="fu">join_by</span>(tara_barcode_num, tara_station)) <span class="sc">%&gt;%</span></span>
<span id="cb28-110"><a href="#cb28-110"></a>  <span class="fu">left_join</span>(PANGAEA_842237, <span class="at">by =</span> <span class="fu">join_by</span>(tara_station)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-111"><a href="#cb28-111"></a>  <span class="fu">mutate</span>(<span class="at">depth =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(depth), (depth_min<span class="sc">+</span>depth_max)<span class="sc">/</span><span class="dv">2</span>, depth)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-112"><a href="#cb28-112"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tara_barcode_num, tara_station, latitude, longitude, date_time, depth) <span class="sc">%&gt;%</span> </span>
<span id="cb28-113"><a href="#cb28-113"></a>  <span class="fu">mutate</span>(<span class="at">date_time =</span> lubridate<span class="sc">::</span><span class="fu">as_date</span>(stringr<span class="sc">::</span><span class="fu">str_extract</span>(date_time, <span class="st">"^</span><span class="sc">\\</span><span class="st">d{4}-</span><span class="sc">\\</span><span class="st">d{2}-</span><span class="sc">\\</span><span class="st">d{2}"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb28-114"><a href="#cb28-114"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-115"><a href="#cb28-115"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-116"><a href="#cb28-116"></a>  <span class="fu">mutate</span>(<span class="at">lat1 =</span> <span class="fu">floor</span>(<span class="fu">first</span>(latitude[<span class="fu">order</span>(latitude)])),</span>
<span id="cb28-117"><a href="#cb28-117"></a>         <span class="at">lat2 =</span> <span class="fu">ceiling</span>(<span class="fu">last</span>(latitude[<span class="fu">order</span>(latitude)])),</span>
<span id="cb28-118"><a href="#cb28-118"></a>         <span class="at">lon1 =</span> <span class="fu">floor</span>(<span class="fu">first</span>(longitude[<span class="fu">order</span>(longitude)])),</span>
<span id="cb28-119"><a href="#cb28-119"></a>         <span class="at">lon2 =</span> <span class="fu">ceiling</span>(<span class="fu">last</span>(longitude[<span class="fu">order</span>(longitude)])),</span>
<span id="cb28-120"><a href="#cb28-120"></a>         <span class="at">dt1 =</span> <span class="fu">floor_date</span>(date_time, <span class="st">'month'</span>),</span>
<span id="cb28-121"><a href="#cb28-121"></a>         <span class="at">dt2 =</span> <span class="fu">ceiling_date</span>(date_time, <span class="st">'month'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-122"><a href="#cb28-122"></a>  <span class="fu">ungroup</span>() </span>
<span id="cb28-123"><a href="#cb28-123"></a></span>
<span id="cb28-124"><a href="#cb28-124"></a><span class="co"># make nested dataset for initial CMAP query</span></span>
<span id="cb28-125"><a href="#cb28-125"></a>tara2darwin_nest <span class="ot">&lt;-</span> tara2darwin <span class="sc">%&gt;%</span> </span>
<span id="cb28-126"><a href="#cb28-126"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tara_station, latitude, longitude, date_time, lat1, lat2, lon1, lon2, dt1, dt2) <span class="sc">%&gt;%</span>  </span>
<span id="cb28-127"><a href="#cb28-127"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-128"><a href="#cb28-128"></a>  tidyr<span class="sc">::</span><span class="fu">nest</span>(<span class="at">dw_query =</span> <span class="sc">-</span>tara_station)</span>
<span id="cb28-129"><a href="#cb28-129"></a><span class="in">```</span></span>
<span id="cb28-130"><a href="#cb28-130"></a></span>
<span id="cb28-131"><a href="#cb28-131"></a><span class="fu"># Darwin Biogeochemistry 3 Day Averaged model output</span></span>
<span id="cb28-132"><a href="#cb28-132"></a></span>
<span id="cb28-133"><a href="#cb28-133"></a><span class="at">&gt; This dataset contains 3-day averaged model nutrient outputs for the global ocean at 50 depth levels. This version of the model is modified from </span><span class="co">[</span><span class="ot">Dutkiewicz et al. (2015)</span><span class="co">](https://bg.copernicus.org/articles/12/4447/2015/)</span><span class="at"> and </span><span class="co">[</span><span class="ot">Ward et al. (2012)</span><span class="co">](https://doi.org/10.4319/lo.2012.57.6.1877)</span><span class="at">. It includes the biogeochemical cycling of carbon, nitrogen, phosphorus, silica, iron and oxygen, a complex marine ecosystem, incorporating both functional and size diversity of phytoplankton and zooplankton, as well as dissolved organic matter (including an explicit colored component, CDOM), and organic particulate matter. An explicit radiative transfer component and spectral treatment of irradiance provides output that is similar to data provided by ocean color satellite instruments (surface reflectance) and also subsurface optical characteristics such as absorption and scattering. There are 35 phytoplankton types (2 pico-prokaryotes, 2 pico-eukaryotes, 5 coccolithophore, 5 diazotrophs, 11 diatoms, 10 mixotrophic dinoflagellates) and 16 zooplankton types ranging from 0.6µm to 2500 µm equivalent spherical diameter. Parameters influencing growth, grazing, and sinking are related to size (following </span><span class="co">[</span><span class="ot">Ward et al. (2012)</span><span class="co">](https://doi.org/10.4319/lo.2012.57.6.1877)</span><span class="at">) with specific differences between functional groups. This simulation uses Monod kinetics, and C:N:P:Fe stoichiometry are constant over time (though do differ between different phytoplankton groups). The zooplankton preferentially graze on plankton 10 times smaller than themselves with a Holling III function. The distributions of the plankton in this model compare well with both observations based on functional types as well as size distributions. We have incorporated distinct absorption and scattering spectra for the different phytoplankton (as in </span><span class="co">[</span><span class="ot">Dutkiewicz et al. (2015)</span><span class="co">](https://bg.copernicus.org/articles/12/4447/2015/)</span><span class="at">) as well as flattening of the spectra with size for absorption and scattering. In Darwin_v0.2_cs510, this ecosystem model is driven by the physical ocean model of </span><span class="co">[</span><span class="ot">Menemenlis et al 2008</span><span class="co">](https://www.mercator-ocean.eu/wp-content/uploads/2015/06/lettre_31_en.pdf)</span><span class="at"> (ECCO2). The grid is a cubed sphere with nominal resolution of 18km such that it is “eddy-permitting” in that it captures eddies and fronts at the mesoscale (order 100km), but not at the sub-mesoscale (order 10kms). Results here have been interpolated to a 0.5 degree grid. The ECCO2 synthesis covers the period 1992– 2015. The physical solution has been obtained using a data constrained Green's Function approach to estimate initial temperature and salinity conditions, surface boundary conditions, and several empirical ocean and sea ice model parameters. The control parameters include initial temperature and salinity conditions, atmospheric surface boundary conditions, background vertical diffusivity, critical Richardson numbers for the KPP scheme, air-ocean, ice-ocean, air-ice drag coefficients, ice/ocean/snow albedo coefficients, bottom drag, and vertical viscosity. Data constraints include sea level anomaly from altimeter data, time- mean sea level, sea surface temperature, temperature, and salinity profiles from WOCE, TAO, ARGO, XBT, etc., sea ice concentration from passive microwave data, sea ice motion from radiometers, QuikSCAT, and RGPS, and sea ice thickness from ULS. Full depth biogeochemical solutions at native eddying resolutions are available via OpenDAP.</span></span>
<span id="cb28-134"><a href="#cb28-134"></a></span>
<span id="cb28-135"><a href="#cb28-135"></a><span class="fu">## tblDarwin_Nutrient</span></span>
<span id="cb28-136"><a href="#cb28-136"></a></span>
<span id="cb28-137"><a href="#cb28-137"></a>Source: <span class="ot">&lt;https://simonscmap.com/catalog/datasets/Darwin_Nutrient&gt;</span></span>
<span id="cb28-138"><a href="#cb28-138"></a></span>
<span id="cb28-139"><a href="#cb28-139"></a><span class="fu">### Download full query range</span></span>
<span id="cb28-140"><a href="#cb28-140"></a></span>
<span id="cb28-143"><a href="#cb28-143"></a><span class="in">```{r}</span></span>
<span id="cb28-144"><a href="#cb28-144"></a><span class="co">#| echo: true</span></span>
<span id="cb28-145"><a href="#cb28-145"></a><span class="co">#| eval: false</span></span>
<span id="cb28-146"><a href="#cb28-146"></a><span class="co">#| output: false</span></span>
<span id="cb28-147"><a href="#cb28-147"></a>tara_tblDarwin_Nutrient <span class="ot">&lt;-</span> tara2darwin_nest <span class="sc">%&gt;%</span></span>
<span id="cb28-148"><a href="#cb28-148"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tbl =</span> purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb28-149"><a href="#cb28-149"></a>    dw_query,</span>
<span id="cb28-150"><a href="#cb28-150"></a>    purrr<span class="sc">::</span><span class="fu">slowly</span>(</span>
<span id="cb28-151"><a href="#cb28-151"></a>      <span class="cf">function</span>(df)</span>
<span id="cb28-152"><a href="#cb28-152"></a>        cmap4r<span class="sc">::</span><span class="fu">get_spacetime</span>(</span>
<span id="cb28-153"><a href="#cb28-153"></a>          <span class="at">tableName =</span> <span class="st">'tblDarwin_Nutrient'</span>,</span>
<span id="cb28-154"><a href="#cb28-154"></a>          <span class="at">varName =</span> <span class="st">'*'</span>,</span>
<span id="cb28-155"><a href="#cb28-155"></a>          <span class="at">dt1 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>dt1),</span>
<span id="cb28-156"><a href="#cb28-156"></a>          <span class="at">dt2 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>dt2),</span>
<span id="cb28-157"><a href="#cb28-157"></a>          <span class="at">lat1 =</span> df<span class="sc">$</span>lat1,</span>
<span id="cb28-158"><a href="#cb28-158"></a>          <span class="at">lat2 =</span> df<span class="sc">$</span>lat2,</span>
<span id="cb28-159"><a href="#cb28-159"></a>          <span class="at">lon1 =</span> df<span class="sc">$</span>lon1,</span>
<span id="cb28-160"><a href="#cb28-160"></a>          <span class="at">lon2 =</span> df<span class="sc">$</span>lon2</span>
<span id="cb28-161"><a href="#cb28-161"></a>        ),</span>
<span id="cb28-162"><a href="#cb28-162"></a>      <span class="at">rate =</span> <span class="fu">rate_delay</span>(<span class="dv">3</span>),</span>
<span id="cb28-163"><a href="#cb28-163"></a>      <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb28-164"><a href="#cb28-164"></a>    ),</span>
<span id="cb28-165"><a href="#cb28-165"></a>    <span class="at">.progress =</span> <span class="cn">TRUE</span></span>
<span id="cb28-166"><a href="#cb28-166"></a>  ))</span>
<span id="cb28-167"><a href="#cb28-167"></a></span>
<span id="cb28-168"><a href="#cb28-168"></a>tara_tblDarwin_Nutrient <span class="sc">%&gt;%</span> </span>
<span id="cb28-169"><a href="#cb28-169"></a>  <span class="fu">unnest</span>(<span class="fu">c</span>(tbl, dw_query)) <span class="sc">%&gt;%</span></span>
<span id="cb28-170"><a href="#cb28-170"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">depth_dw =</span> depth, <span class="at">lat_dw=</span>lat, <span class="at">lon_dw=</span>lon, <span class="at">time_dw=</span>time) <span class="sc">%&gt;%</span> </span>
<span id="cb28-171"><a href="#cb28-171"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_station, lat_dw, lon_dw, depth_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb28-172"><a href="#cb28-172"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Nutrient_subset.parquet"</span>))</span>
<span id="cb28-173"><a href="#cb28-173"></a><span class="in">```</span></span>
<span id="cb28-174"><a href="#cb28-174"></a></span>
<span id="cb28-175"><a href="#cb28-175"></a><span class="fu">### Filter to closest Tara matches</span></span>
<span id="cb28-176"><a href="#cb28-176"></a></span>
<span id="cb28-177"><a href="#cb28-177"></a>Filtering Darwin output to only closest matching time, distance, and depth. Difference in times are computed using <span class="in">`lubridate`</span> package. Distance between two coordinate sets is calculated by the Haversine distance implemented by <span class="in">`geosphere::distHaversine`</span>. Distance between depths is calculated as a simple difference.</span>
<span id="cb28-178"><a href="#cb28-178"></a></span>
<span id="cb28-179"><a href="#cb28-179"></a>There are two special considerations:</span>
<span id="cb28-180"><a href="#cb28-180"></a></span>
<span id="cb28-181"><a href="#cb28-181"></a>1)  Some Tara stations are close to land and picking grid points with minimum Haversine distance to the Tara coordinates will end up selecting positions on land. We include a filtering criteria to exclude all Tara grid points that contain only NA values for DIN/PO4/SiOH4 for all depths.</span>
<span id="cb28-182"><a href="#cb28-182"></a></span>
<span id="cb28-183"><a href="#cb28-183"></a>2)  Tara station TARA_209 is located off of Greenland on the shelf. The sampling depth for the mesopelagic samples is listed as 351 meters. However, in Pangaea datasets the bathymetry depth for this coordinate set is 215 meters. In Darwin (and PISCES) there are no observations at 351 meters, so we instead choose the minimum depth difference between 351 meters and the model depth level with a DIN/PO4/SiOH4 value/.</span>
<span id="cb28-184"><a href="#cb28-184"></a></span>
<span id="cb28-187"><a href="#cb28-187"></a><span class="in">```{r}</span></span>
<span id="cb28-188"><a href="#cb28-188"></a>tblDarwin_Nutrient_subset_filt <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Nutrient_subset.parquet"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-189"><a href="#cb28-189"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">time_dw =</span> lubridate<span class="sc">::</span><span class="fu">as_date</span>(stringr<span class="sc">::</span><span class="fu">str_extract</span>(time_dw, <span class="st">"^</span><span class="sc">\\</span><span class="st">d{4}-</span><span class="sc">\\</span><span class="st">d{2}-</span><span class="sc">\\</span><span class="st">d{2}"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb28-190"><a href="#cb28-190"></a>  <span class="co"># calculate difference in date between darwin and Tara</span></span>
<span id="cb28-191"><a href="#cb28-191"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tdiff =</span> <span class="fu">abs</span>(time_dw <span class="sc">-</span> date_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-192"><a href="#cb28-192"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(tara_station, latitude, longitude, date_time) <span class="sc">%&gt;%</span> </span>
<span id="cb28-193"><a href="#cb28-193"></a>  <span class="co"># filter to include only darwin time points with smallest time difference to Tara observation </span></span>
<span id="cb28-194"><a href="#cb28-194"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(tdiff <span class="sc">==</span> <span class="fu">min</span>(tdiff)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-195"><a href="#cb28-195"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-196"><a href="#cb28-196"></a>  <span class="co"># remove Darwin grid coords that only contain NA values for DIN (these are either on land or ice)</span></span>
<span id="cb28-197"><a href="#cb28-197"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(tara_station, lat_dw, lon_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb28-198"><a href="#cb28-198"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">sum</span>(<span class="fu">is.na</span>(DIN)) <span class="sc">!=</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb28-199"><a href="#cb28-199"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-200"><a href="#cb28-200"></a>  dplyr<span class="sc">::</span><span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-201"><a href="#cb28-201"></a>  <span class="co"># calculate Haversine distance (in meters) betwen darwin coord set and Tara coord set</span></span>
<span id="cb28-202"><a href="#cb28-202"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">ddiff =</span> geosphere<span class="sc">::</span><span class="fu">distHaversine</span>(<span class="fu">c</span>(longitude, latitude), <span class="fu">c</span>(lon_dw, lat_dw))) <span class="sc">%&gt;%</span> </span>
<span id="cb28-203"><a href="#cb28-203"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(tara_station, latitude, longitude, date_time) <span class="sc">%&gt;%</span> </span>
<span id="cb28-204"><a href="#cb28-204"></a>  <span class="co"># filter to include only darwin grid point with smallest Haversine distance</span></span>
<span id="cb28-205"><a href="#cb28-205"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(ddiff <span class="sc">==</span> <span class="fu">min</span>(ddiff)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-206"><a href="#cb28-206"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-207"><a href="#cb28-207"></a>  <span class="co"># join back to the full dataset that includes depths for Tara samples. We expect a many2many relationship</span></span>
<span id="cb28-208"><a href="#cb28-208"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(tara2darwin,</span>
<span id="cb28-209"><a href="#cb28-209"></a>                  <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, latitude, longitude, date_time, lat1, lat2, lon1, lon2, dt1, dt2),</span>
<span id="cb28-210"><a href="#cb28-210"></a>                  <span class="at">relationship =</span> <span class="st">"many-to-many"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-211"><a href="#cb28-211"></a>  <span class="co"># calculate difference in magnitude between darwin depth and Tara observation</span></span>
<span id="cb28-212"><a href="#cb28-212"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">dpdiff =</span> <span class="fu">abs</span>(depth_dw <span class="sc">-</span> depth)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-213"><a href="#cb28-213"></a>  <span class="co"># filter to only consider Darwin grid points with DIN observations</span></span>
<span id="cb28-214"><a href="#cb28-214"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(DIN)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-215"><a href="#cb28-215"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(tara_station, latitude, longitude, date_time, depth) <span class="sc">%&gt;%</span> </span>
<span id="cb28-216"><a href="#cb28-216"></a>  <span class="co"># filter to include only smallest depth difference</span></span>
<span id="cb28-217"><a href="#cb28-217"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(dpdiff <span class="sc">==</span> <span class="fu">min</span>(dpdiff)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-218"><a href="#cb28-218"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-219"><a href="#cb28-219"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(tara_station, latitude, longitude, date_time, depth) <span class="sc">%&gt;%</span> </span>
<span id="cb28-220"><a href="#cb28-220"></a>  <span class="co"># Some observations have multiple equal depth differences (e.g., target depth is 50 and nearest </span></span>
<span id="cb28-221"><a href="#cb28-221"></a>  <span class="co"># Darwin depths are 45 and 55) this ensures we only take one of them</span></span>
<span id="cb28-222"><a href="#cb28-222"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(depth_dw <span class="sc">==</span> <span class="fu">min</span>(depth_dw)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-223"><a href="#cb28-223"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-224"><a href="#cb28-224"></a>  <span class="co"># recording the difference between Darwin grid point and Tara coords, difference between depths and times</span></span>
<span id="cb28-225"><a href="#cb28-225"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tdiff =</span> lubridate<span class="sc">::</span><span class="fu">make_difftime</span>(tdiff, <span class="at">units =</span> <span class="st">"hours"</span>),</span>
<span id="cb28-226"><a href="#cb28-226"></a>                <span class="at">ddiff =</span> ddiff<span class="sc">/</span><span class="dv">1000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-227"><a href="#cb28-227"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">time_diff_hr =</span> tdiff, <span class="at">dist_diff_km =</span> ddiff, <span class="at">depth_diff_m =</span> dpdiff ) <span class="sc">%&gt;%</span> </span>
<span id="cb28-228"><a href="#cb28-228"></a>  <span class="co"># some formatting and cleaning</span></span>
<span id="cb28-229"><a href="#cb28-229"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_barcode_num, tara_station<span class="sc">:</span>longitude, depth, date_time, </span>
<span id="cb28-230"><a href="#cb28-230"></a>                  lat_dw, lon_dw, depth_dw, time_dw, dist_diff_km, depth_diff_m, time_diff_hr) <span class="sc">%&gt;%</span> </span>
<span id="cb28-231"><a href="#cb28-231"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>(lat1<span class="sc">:</span>dt2)) </span>
<span id="cb28-232"><a href="#cb28-232"></a></span>
<span id="cb28-233"><a href="#cb28-233"></a><span class="co"># write output for later</span></span>
<span id="cb28-234"><a href="#cb28-234"></a>arrow<span class="sc">::</span><span class="fu">write_parquet</span>(tblDarwin_Nutrient_subset_filt, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Nutrient_subset_filt.parquet"</span>))</span>
<span id="cb28-235"><a href="#cb28-235"></a><span class="in">```</span></span>
<span id="cb28-236"><a href="#cb28-236"></a></span>
<span id="cb28-237"><a href="#cb28-237"></a><span class="fu">### Save closest Darwin grid coords</span></span>
<span id="cb28-238"><a href="#cb28-238"></a></span>
<span id="cb28-239"><a href="#cb28-239"></a>Write 0.25 degree resolved coordinates for later access to Darwin without needing a 1 degree range. It is faster to use exact coords in the API</span>
<span id="cb28-240"><a href="#cb28-240"></a></span>
<span id="cb28-243"><a href="#cb28-243"></a><span class="in">```{r}</span></span>
<span id="cb28-244"><a href="#cb28-244"></a>darwin_tara_grid_map <span class="ot">&lt;-</span> tblDarwin_Nutrient_subset_filt <span class="sc">%&gt;%</span> </span>
<span id="cb28-245"><a href="#cb28-245"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tara_station<span class="sc">:</span>time_diff_hr) <span class="sc">%&gt;%</span> </span>
<span id="cb28-246"><a href="#cb28-246"></a>  <span class="fu">distinct</span>() </span>
<span id="cb28-247"><a href="#cb28-247"></a></span>
<span id="cb28-248"><a href="#cb28-248"></a>arrow<span class="sc">::</span><span class="fu">write_parquet</span>(darwin_tara_grid_map, here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"darwin_tara_grid_map.parquet"</span>))</span>
<span id="cb28-249"><a href="#cb28-249"></a><span class="in">```</span></span>
<span id="cb28-250"><a href="#cb28-250"></a></span>
<span id="cb28-251"><a href="#cb28-251"></a><span class="fu">### Save closest PISCES grid coords</span></span>
<span id="cb28-252"><a href="#cb28-252"></a></span>
<span id="cb28-253"><a href="#cb28-253"></a>Write 0.25 degree resolved coordinates for later access to PISCES. We'll use these in the next notebook</span>
<span id="cb28-254"><a href="#cb28-254"></a></span>
<span id="cb28-257"><a href="#cb28-257"></a><span class="in">```{r}</span></span>
<span id="cb28-258"><a href="#cb28-258"></a>tblDarwin_Nutrient_subset_filt <span class="sc">%&gt;%</span> </span>
<span id="cb28-259"><a href="#cb28-259"></a>  <span class="co"># the only reason I know to set this to 200 is by looking at PISCES output from this grid coords and seeing that </span></span>
<span id="cb28-260"><a href="#cb28-260"></a>  <span class="co"># the maximum depth was 199 meters</span></span>
<span id="cb28-261"><a href="#cb28-261"></a>  <span class="fu">mutate</span>(<span class="at">depth =</span> <span class="fu">if_else</span>(tara_station <span class="sc">==</span> <span class="st">"TARA_209"</span> <span class="sc">&amp;</span> depth <span class="sc">==</span> <span class="dv">351</span>, <span class="dv">200</span>, depth)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-262"><a href="#cb28-262"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tara_station, <span class="at">lat_cm=</span>lat_dw, latitude, <span class="at">lon_cm=</span>lon_dw, longitude, depth, date_time, dist_diff_km) <span class="sc">%&gt;%</span> </span>
<span id="cb28-263"><a href="#cb28-263"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-264"><a href="#cb28-264"></a>  readr<span class="sc">::</span><span class="fu">write_csv</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"pisces_subsets"</span>, <span class="st">"pisces_tara_grid_map.csv"</span>))</span>
<span id="cb28-265"><a href="#cb28-265"></a><span class="in">```</span></span>
<span id="cb28-266"><a href="#cb28-266"></a></span>
<span id="cb28-267"><a href="#cb28-267"></a><span class="fu">## tblDarwin_Ecosystem</span></span>
<span id="cb28-268"><a href="#cb28-268"></a></span>
<span id="cb28-269"><a href="#cb28-269"></a>Source: <span class="ot">&lt;https://simonscmap.com/catalog/datasets/Darwin_Ecosystem&gt;</span></span>
<span id="cb28-270"><a href="#cb28-270"></a></span>
<span id="cb28-271"><a href="#cb28-271"></a>Now we can use the exact coordinates and dates in our SQL queries to CMAP so that we reduce the amount of data needed to transfer. This version of the variable <span class="in">`tara2darwin_nest`</span> has the best mapping (i.e. smallest Haversine distance) between the Tara coordinate and the grid in MIT Darwin.</span>
<span id="cb28-272"><a href="#cb28-272"></a></span>
<span id="cb28-275"><a href="#cb28-275"></a><span class="in">```{r}</span></span>
<span id="cb28-276"><a href="#cb28-276"></a>darwin_tara_grid_map <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"darwin_tara_grid_map.parquet"</span>))</span>
<span id="cb28-277"><a href="#cb28-277"></a></span>
<span id="cb28-278"><a href="#cb28-278"></a>tara2darwin_nest <span class="ot">&lt;-</span> darwin_tara_grid_map <span class="sc">%&gt;%</span></span>
<span id="cb28-279"><a href="#cb28-279"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tara_station, lat_dw, lon_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb28-280"><a href="#cb28-280"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-281"><a href="#cb28-281"></a>  tidyr<span class="sc">::</span><span class="fu">nest</span>(<span class="at">dw_query =</span> <span class="sc">-</span>tara_station)</span>
<span id="cb28-282"><a href="#cb28-282"></a><span class="in">```</span></span>
<span id="cb28-283"><a href="#cb28-283"></a></span>
<span id="cb28-284"><a href="#cb28-284"></a><span class="fu">### Download</span></span>
<span id="cb28-285"><a href="#cb28-285"></a></span>
<span id="cb28-288"><a href="#cb28-288"></a><span class="in">```{r}</span></span>
<span id="cb28-289"><a href="#cb28-289"></a><span class="co">#| echo: true</span></span>
<span id="cb28-290"><a href="#cb28-290"></a><span class="co">#| eval: false</span></span>
<span id="cb28-291"><a href="#cb28-291"></a><span class="co">#| output: false</span></span>
<span id="cb28-292"><a href="#cb28-292"></a>tara_tblDarwin_Ecosystem <span class="ot">&lt;-</span> tara2darwin_nest <span class="sc">%&gt;%</span></span>
<span id="cb28-293"><a href="#cb28-293"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tbl =</span> purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb28-294"><a href="#cb28-294"></a>    dw_query,</span>
<span id="cb28-295"><a href="#cb28-295"></a>    purrr<span class="sc">::</span><span class="fu">slowly</span>(</span>
<span id="cb28-296"><a href="#cb28-296"></a>      <span class="cf">function</span>(df)</span>
<span id="cb28-297"><a href="#cb28-297"></a>        cmap4r<span class="sc">::</span><span class="fu">get_spacetime</span>(</span>
<span id="cb28-298"><a href="#cb28-298"></a>          <span class="at">tableName =</span> <span class="st">'tblDarwin_Ecosystem'</span>,</span>
<span id="cb28-299"><a href="#cb28-299"></a>          <span class="at">varName =</span> <span class="st">'*'</span>,</span>
<span id="cb28-300"><a href="#cb28-300"></a>          <span class="at">dt1 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>time_dw),</span>
<span id="cb28-301"><a href="#cb28-301"></a>          <span class="at">dt2 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>time_dw),</span>
<span id="cb28-302"><a href="#cb28-302"></a>          <span class="at">lat1 =</span> df<span class="sc">$</span>lat_dw,</span>
<span id="cb28-303"><a href="#cb28-303"></a>          <span class="at">lat2 =</span> df<span class="sc">$</span>lat_dw,</span>
<span id="cb28-304"><a href="#cb28-304"></a>          <span class="at">lon1 =</span> df<span class="sc">$</span>lon_dw,</span>
<span id="cb28-305"><a href="#cb28-305"></a>          <span class="at">lon2 =</span> df<span class="sc">$</span>lon_dw</span>
<span id="cb28-306"><a href="#cb28-306"></a>        ),</span>
<span id="cb28-307"><a href="#cb28-307"></a>      <span class="co"># using a 3 second rate delay between calls</span></span>
<span id="cb28-308"><a href="#cb28-308"></a>      <span class="at">rate =</span> <span class="fu">rate_delay</span>(<span class="dv">3</span>),</span>
<span id="cb28-309"><a href="#cb28-309"></a>      <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb28-310"><a href="#cb28-310"></a>    ),</span>
<span id="cb28-311"><a href="#cb28-311"></a>    <span class="at">.progress =</span> <span class="cn">TRUE</span></span>
<span id="cb28-312"><a href="#cb28-312"></a>  ))</span>
<span id="cb28-313"><a href="#cb28-313"></a></span>
<span id="cb28-314"><a href="#cb28-314"></a>tara_tblDarwin_Ecosystem <span class="sc">%&gt;%</span> </span>
<span id="cb28-315"><a href="#cb28-315"></a>  <span class="fu">unnest</span>(<span class="fu">c</span>(tbl)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-316"><a href="#cb28-316"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">time_dw =</span> time, <span class="at">lat_dw =</span> lat, <span class="at">lon_dw =</span> lon, <span class="at">depth_dw =</span> depth) <span class="sc">%&gt;%</span> </span>
<span id="cb28-317"><a href="#cb28-317"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dw_query) <span class="sc">%&gt;%</span> </span>
<span id="cb28-318"><a href="#cb28-318"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Ecosystem_subset.parquet"</span>))</span>
<span id="cb28-319"><a href="#cb28-319"></a><span class="in">```</span></span>
<span id="cb28-320"><a href="#cb28-320"></a></span>
<span id="cb28-321"><a href="#cb28-321"></a><span class="fu">### Filtering</span></span>
<span id="cb28-322"><a href="#cb28-322"></a></span>
<span id="cb28-323"><a href="#cb28-323"></a>Filtering Darwin output to only closest matching depth. Distance between depths is calculated as a simple difference.</span>
<span id="cb28-324"><a href="#cb28-324"></a></span>
<span id="cb28-327"><a href="#cb28-327"></a><span class="in">```{r}</span></span>
<span id="cb28-328"><a href="#cb28-328"></a><span class="fu">left_join</span>(darwin_tara_grid_map,</span>
<span id="cb28-329"><a href="#cb28-329"></a>          arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Ecosystem_subset.parquet"</span>)),</span>
<span id="cb28-330"><a href="#cb28-330"></a>          <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, lat_dw, lon_dw, depth_dw, time_dw)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-331"><a href="#cb28-331"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(tara2darwin, <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, latitude, longitude, depth, date_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-332"><a href="#cb28-332"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_barcode_num, tara_station, latitude, longitude, depth, date_time, lat_dw, lon_dw, depth_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb28-333"><a href="#cb28-333"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dist_diff_km, <span class="sc">-</span>depth_diff_m, <span class="sc">-</span>time_diff_hr, <span class="sc">-</span>lat1, <span class="sc">-</span>lat2, <span class="sc">-</span>lon1, <span class="sc">-</span>lon2, <span class="sc">-</span>dt1, <span class="sc">-</span>dt2) <span class="sc">%&gt;%</span> </span>
<span id="cb28-334"><a href="#cb28-334"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Ecosystem_subset_filt.parquet"</span>))</span>
<span id="cb28-335"><a href="#cb28-335"></a><span class="in">```</span></span>
<span id="cb28-336"><a href="#cb28-336"></a></span>
<span id="cb28-337"><a href="#cb28-337"></a><span class="fu">## tblDarwin_Ocean_Color</span></span>
<span id="cb28-338"><a href="#cb28-338"></a></span>
<span id="cb28-339"><a href="#cb28-339"></a>Source: <span class="ot">&lt;https://simonscmap.com/catalog/datasets/Darwin_Ocean_Color&gt;</span></span>
<span id="cb28-340"><a href="#cb28-340"></a></span>
<span id="cb28-343"><a href="#cb28-343"></a><span class="in">```{r}</span></span>
<span id="cb28-344"><a href="#cb28-344"></a>darwin_tara_grid_map <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"darwin_tara_grid_map.parquet"</span>))</span>
<span id="cb28-345"><a href="#cb28-345"></a></span>
<span id="cb28-346"><a href="#cb28-346"></a>tara2darwin_nest <span class="ot">&lt;-</span> darwin_tara_grid_map <span class="sc">%&gt;%</span></span>
<span id="cb28-347"><a href="#cb28-347"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tara_station, lat_dw, lon_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb28-348"><a href="#cb28-348"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-349"><a href="#cb28-349"></a>  tidyr<span class="sc">::</span><span class="fu">nest</span>(<span class="at">dw_query =</span> <span class="sc">-</span>tara_station)</span>
<span id="cb28-350"><a href="#cb28-350"></a><span class="in">```</span></span>
<span id="cb28-351"><a href="#cb28-351"></a></span>
<span id="cb28-352"><a href="#cb28-352"></a><span class="fu">### Download</span></span>
<span id="cb28-353"><a href="#cb28-353"></a></span>
<span id="cb28-356"><a href="#cb28-356"></a><span class="in">```{r}</span></span>
<span id="cb28-357"><a href="#cb28-357"></a><span class="co">#| echo: true</span></span>
<span id="cb28-358"><a href="#cb28-358"></a><span class="co">#| eval: false</span></span>
<span id="cb28-359"><a href="#cb28-359"></a><span class="co">#| output: false</span></span>
<span id="cb28-360"><a href="#cb28-360"></a>tara_tblDarwin_Ocean_Color <span class="ot">&lt;-</span> tara2darwin_nest <span class="sc">%&gt;%</span></span>
<span id="cb28-361"><a href="#cb28-361"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tbl =</span> purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb28-362"><a href="#cb28-362"></a>    dw_query,</span>
<span id="cb28-363"><a href="#cb28-363"></a>    purrr<span class="sc">::</span><span class="fu">slowly</span>(</span>
<span id="cb28-364"><a href="#cb28-364"></a>      <span class="cf">function</span>(df)</span>
<span id="cb28-365"><a href="#cb28-365"></a>        cmap4r<span class="sc">::</span><span class="fu">get_spacetime</span>(</span>
<span id="cb28-366"><a href="#cb28-366"></a>          <span class="at">tableName =</span> <span class="st">'tblDarwin_Ocean_Color'</span>,</span>
<span id="cb28-367"><a href="#cb28-367"></a>          <span class="at">varName =</span> <span class="st">'*'</span>,</span>
<span id="cb28-368"><a href="#cb28-368"></a>          <span class="at">dt1 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>time_dw),</span>
<span id="cb28-369"><a href="#cb28-369"></a>          <span class="at">dt2 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>time_dw),</span>
<span id="cb28-370"><a href="#cb28-370"></a>          <span class="at">lat1 =</span> df<span class="sc">$</span>lat_dw,</span>
<span id="cb28-371"><a href="#cb28-371"></a>          <span class="at">lat2 =</span> df<span class="sc">$</span>lat_dw,</span>
<span id="cb28-372"><a href="#cb28-372"></a>          <span class="at">lon1 =</span> df<span class="sc">$</span>lon_dw,</span>
<span id="cb28-373"><a href="#cb28-373"></a>          <span class="at">lon2 =</span> df<span class="sc">$</span>lon_dw</span>
<span id="cb28-374"><a href="#cb28-374"></a>        ),</span>
<span id="cb28-375"><a href="#cb28-375"></a>      <span class="at">rate =</span> <span class="fu">rate_delay</span>(<span class="dv">3</span>),</span>
<span id="cb28-376"><a href="#cb28-376"></a>      <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb28-377"><a href="#cb28-377"></a>    ),</span>
<span id="cb28-378"><a href="#cb28-378"></a>    <span class="at">.progress =</span> <span class="cn">TRUE</span></span>
<span id="cb28-379"><a href="#cb28-379"></a>  ))</span>
<span id="cb28-380"><a href="#cb28-380"></a></span>
<span id="cb28-381"><a href="#cb28-381"></a>tara_tblDarwin_Ocean_Color <span class="sc">%&gt;%</span></span>
<span id="cb28-382"><a href="#cb28-382"></a>  <span class="fu">unnest</span>(<span class="fu">c</span>(tbl)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-383"><a href="#cb28-383"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">time_dw =</span> time, <span class="at">lat_dw =</span> lat, <span class="at">lon_dw =</span> lon, <span class="at">depth_dw =</span> depth) <span class="sc">%&gt;%</span> </span>
<span id="cb28-384"><a href="#cb28-384"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dw_query) <span class="sc">%&gt;%</span> </span>
<span id="cb28-385"><a href="#cb28-385"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Ocean_Color_subset.parquet"</span>))</span>
<span id="cb28-386"><a href="#cb28-386"></a><span class="in">```</span></span>
<span id="cb28-387"><a href="#cb28-387"></a></span>
<span id="cb28-388"><a href="#cb28-388"></a><span class="fu">### Filtering</span></span>
<span id="cb28-389"><a href="#cb28-389"></a></span>
<span id="cb28-390"><a href="#cb28-390"></a>Filtering Darwin output to only closest matching depth. Distance between depths is calculated as a simple difference.</span>
<span id="cb28-391"><a href="#cb28-391"></a></span>
<span id="cb28-394"><a href="#cb28-394"></a><span class="in">```{r}</span></span>
<span id="cb28-395"><a href="#cb28-395"></a><span class="fu">left_join</span>(darwin_tara_grid_map,</span>
<span id="cb28-396"><a href="#cb28-396"></a>          arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Ocean_Color_subset.parquet"</span>)),</span>
<span id="cb28-397"><a href="#cb28-397"></a>          <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, lat_dw, lon_dw, depth_dw, time_dw)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-398"><a href="#cb28-398"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(tara2darwin, <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, latitude, longitude, depth, date_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-399"><a href="#cb28-399"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_barcode_num, tara_station, latitude, longitude, depth, date_time, lat_dw, lon_dw, depth_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb28-400"><a href="#cb28-400"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dist_diff_km, <span class="sc">-</span>depth_diff_m, <span class="sc">-</span>time_diff_hr, <span class="sc">-</span>lat1, <span class="sc">-</span>lat2, <span class="sc">-</span>lon1, <span class="sc">-</span>lon2, <span class="sc">-</span>dt1, <span class="sc">-</span>dt2) <span class="sc">%&gt;%</span> </span>
<span id="cb28-401"><a href="#cb28-401"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Ocean_Color_subset_filt.parquet"</span>))</span>
<span id="cb28-402"><a href="#cb28-402"></a><span class="in">```</span></span>
<span id="cb28-403"><a href="#cb28-403"></a></span>
<span id="cb28-404"><a href="#cb28-404"></a><span class="fu">## tblDarwin_Phytoplankton</span></span>
<span id="cb28-405"><a href="#cb28-405"></a></span>
<span id="cb28-406"><a href="#cb28-406"></a>Source: <span class="ot">&lt;https://simonscmap.com/catalog/datasets/Darwin_Phytoplankton&gt;</span></span>
<span id="cb28-407"><a href="#cb28-407"></a></span>
<span id="cb28-410"><a href="#cb28-410"></a><span class="in">```{r}</span></span>
<span id="cb28-411"><a href="#cb28-411"></a>darwin_tara_grid_map <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"darwin_tara_grid_map.parquet"</span>))</span>
<span id="cb28-412"><a href="#cb28-412"></a></span>
<span id="cb28-413"><a href="#cb28-413"></a>tara2darwin_nest <span class="ot">&lt;-</span> darwin_tara_grid_map <span class="sc">%&gt;%</span></span>
<span id="cb28-414"><a href="#cb28-414"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tara_station, lat_dw, lon_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb28-415"><a href="#cb28-415"></a>  <span class="fu">distinct</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-416"><a href="#cb28-416"></a>  tidyr<span class="sc">::</span><span class="fu">nest</span>(<span class="at">dw_query =</span> <span class="sc">-</span>tara_station)</span>
<span id="cb28-417"><a href="#cb28-417"></a><span class="in">```</span></span>
<span id="cb28-418"><a href="#cb28-418"></a></span>
<span id="cb28-419"><a href="#cb28-419"></a><span class="fu">### Download</span></span>
<span id="cb28-420"><a href="#cb28-420"></a></span>
<span id="cb28-423"><a href="#cb28-423"></a><span class="in">```{r}</span></span>
<span id="cb28-424"><a href="#cb28-424"></a><span class="co">#| echo: true</span></span>
<span id="cb28-425"><a href="#cb28-425"></a><span class="co">#| eval: false</span></span>
<span id="cb28-426"><a href="#cb28-426"></a><span class="co">#| output: false</span></span>
<span id="cb28-427"><a href="#cb28-427"></a>tara_tblDarwin_Phytoplankton <span class="ot">&lt;-</span> tara2darwin_nest <span class="sc">%&gt;%</span></span>
<span id="cb28-428"><a href="#cb28-428"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">tbl =</span> purrr<span class="sc">::</span><span class="fu">map</span>(</span>
<span id="cb28-429"><a href="#cb28-429"></a>    dw_query,</span>
<span id="cb28-430"><a href="#cb28-430"></a>    purrr<span class="sc">::</span><span class="fu">slowly</span>(</span>
<span id="cb28-431"><a href="#cb28-431"></a>      <span class="cf">function</span>(df)</span>
<span id="cb28-432"><a href="#cb28-432"></a>        cmap4r<span class="sc">::</span><span class="fu">get_spacetime</span>(</span>
<span id="cb28-433"><a href="#cb28-433"></a>          <span class="at">tableName =</span> <span class="st">'tblDarwin_Phytoplankton'</span>,</span>
<span id="cb28-434"><a href="#cb28-434"></a>          <span class="at">varName =</span> <span class="st">'*'</span>,</span>
<span id="cb28-435"><a href="#cb28-435"></a>          <span class="at">dt1 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>time_dw),</span>
<span id="cb28-436"><a href="#cb28-436"></a>          <span class="at">dt2 =</span> <span class="fu">as.character</span>(df<span class="sc">$</span>time_dw),</span>
<span id="cb28-437"><a href="#cb28-437"></a>          <span class="at">lat1 =</span> df<span class="sc">$</span>lat_dw,</span>
<span id="cb28-438"><a href="#cb28-438"></a>          <span class="at">lat2 =</span> df<span class="sc">$</span>lat_dw,</span>
<span id="cb28-439"><a href="#cb28-439"></a>          <span class="at">lon1 =</span> df<span class="sc">$</span>lon_dw,</span>
<span id="cb28-440"><a href="#cb28-440"></a>          <span class="at">lon2 =</span> df<span class="sc">$</span>lon_dw</span>
<span id="cb28-441"><a href="#cb28-441"></a>        ),</span>
<span id="cb28-442"><a href="#cb28-442"></a>      <span class="at">rate =</span> <span class="fu">rate_delay</span>(<span class="dv">3</span>),</span>
<span id="cb28-443"><a href="#cb28-443"></a>      <span class="at">quiet =</span> <span class="cn">TRUE</span></span>
<span id="cb28-444"><a href="#cb28-444"></a>    ),</span>
<span id="cb28-445"><a href="#cb28-445"></a>    <span class="at">.progress =</span> <span class="cn">TRUE</span></span>
<span id="cb28-446"><a href="#cb28-446"></a>  ))</span>
<span id="cb28-447"><a href="#cb28-447"></a></span>
<span id="cb28-448"><a href="#cb28-448"></a>tara_tblDarwin_Phytoplankton <span class="sc">%&gt;%</span> </span>
<span id="cb28-449"><a href="#cb28-449"></a>  <span class="fu">unnest</span>(<span class="fu">c</span>(tbl)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-450"><a href="#cb28-450"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">time_dw =</span> time, <span class="at">lat_dw =</span> lat, <span class="at">lon_dw =</span> lon, <span class="at">depth_dw =</span> depth) <span class="sc">%&gt;%</span> </span>
<span id="cb28-451"><a href="#cb28-451"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dw_query) <span class="sc">%&gt;%</span> </span>
<span id="cb28-452"><a href="#cb28-452"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Phytoplankton_subset.parquet"</span>))</span>
<span id="cb28-453"><a href="#cb28-453"></a><span class="in">```</span></span>
<span id="cb28-454"><a href="#cb28-454"></a></span>
<span id="cb28-455"><a href="#cb28-455"></a><span class="fu">### Filtering</span></span>
<span id="cb28-456"><a href="#cb28-456"></a></span>
<span id="cb28-457"><a href="#cb28-457"></a>Filtering Darwin output to only closest matching depth. Distance between depths is calculated as a simple difference.</span>
<span id="cb28-458"><a href="#cb28-458"></a></span>
<span id="cb28-461"><a href="#cb28-461"></a><span class="in">```{r}</span></span>
<span id="cb28-462"><a href="#cb28-462"></a><span class="fu">left_join</span>(darwin_tara_grid_map,</span>
<span id="cb28-463"><a href="#cb28-463"></a>          arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Phytoplankton_subset.parquet"</span>)),</span>
<span id="cb28-464"><a href="#cb28-464"></a>          <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, lat_dw, lon_dw, depth_dw, time_dw)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-465"><a href="#cb28-465"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(tara2darwin, <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, latitude, longitude, depth, date_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-466"><a href="#cb28-466"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_barcode_num, tara_station, latitude, longitude, depth, date_time, lat_dw, lon_dw, depth_dw, time_dw) <span class="sc">%&gt;%</span> </span>
<span id="cb28-467"><a href="#cb28-467"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dist_diff_km, <span class="sc">-</span>depth_diff_m, <span class="sc">-</span>time_diff_hr, <span class="sc">-</span>lat1, <span class="sc">-</span>lat2, <span class="sc">-</span>lon1, <span class="sc">-</span>lon2, <span class="sc">-</span>dt1, <span class="sc">-</span>dt2) <span class="sc">%&gt;%</span> </span>
<span id="cb28-468"><a href="#cb28-468"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Phytoplankton_subset_filt.parquet"</span>))</span>
<span id="cb28-469"><a href="#cb28-469"></a><span class="in">```</span></span>
<span id="cb28-470"><a href="#cb28-470"></a></span>
<span id="cb28-471"><a href="#cb28-471"></a><span class="fu"># MIT Darwin biogeochemical model monthly climatology output</span></span>
<span id="cb28-472"><a href="#cb28-472"></a></span>
<span id="cb28-473"><a href="#cb28-473"></a><span class="at">&gt; This version of the model is modified from </span><span class="co">[</span><span class="ot">Dutkiewicz et al. (2015)</span><span class="co">](https://bg.copernicus.org/articles/12/4447/2015/)</span><span class="at"> and </span><span class="co">[</span><span class="ot">Ward et al. (2012)</span><span class="co">](https://doi.org/10.4319/lo.2012.57.6.1877)</span><span class="at">. It includes the biogeochemical cycling of carbon, nitrogen, phosphorus, silica, iron and oxygen, a complex marine ecosystem, incorporating both functional and size diversity of phytoplankton and zooplankton, as well as dissolved organic matter (including an explicit colored component, CDOM), and organic particulate matter. An explicit radiative transfer component and spectral treatment of irradiance provides output that is similar to data provided by ocean color satellite instruments (surface reflectance) and also subsurface optical characteristics such as absorption and scattering. There are 35 phytoplankton types (2 pico-prokaryotes, 2 pico-eukaryotes, 5 coccolithophore, 5 diazotrophs, 11 diatoms, 10 mixotrophic dinoflagellates) and 16 zooplankton types ranging from 0.6µm to 2500 µm equivalent spherical diameter. Parameters influencing growth, grazing, and sinking are related to size (following </span><span class="co">[</span><span class="ot">Ward et al. (2012)</span><span class="co">](https://doi.org/10.4319/lo.2012.57.6.1877)</span><span class="at">) with specific differences between functional groups. This simulation uses Monod kinetics, and C:N:P:Fe stoichiometry are constant over time (though do differ between different phytoplankton groups). The zooplankton preferentially graze on plankton 10 times smaller than themselves with a Holling III function. The distributions of the plankton in this model compare well with both observations based on functional types as well as size distributions. We have incorporated distinct absorption and scattering spectra for the different phytoplankton (as in </span><span class="co">[</span><span class="ot">Dutkiewicz et al. (2015)</span><span class="co">](https://bg.copernicus.org/articles/12/4447/2015/)</span><span class="at">) as well as flattening of the spectra with size for absorption and scattering. In Darwin_v0.1_llc90, this ecosystem model is driven by the physical ocean model of </span><span class="co">[</span><span class="ot">Forget et al, 2015</span><span class="co">](https://doi.org/10.5194/gmd-8-3071-2015,%202015)</span><span class="at"> (ECCO version 4, </span><span class="ot">&lt;https://eccov4.readthedocs.io&gt;</span><span class="at">) which runs on a 1-degree, global grid called LLC90 (</span><span class="co">[</span><span class="ot">Forget et al, 2015</span><span class="co">](https://doi.org/10.5194/gmd-8-3071-2015,%202015)</span><span class="at">). This physical ocean model benefits from optimized parameterizations (small- and meso-scale turbulence) and atmospheric boundary conditions (air-sea fluxes). As a result, it matches in-situ observations (T, S, MLD, etc.) and remote sensing data (SST, altimetry, etc.) better than earlier ECCO solutions do (Forget, Ferreira, Liang 2015, Forget and Ponte 2015). Another advantage of this model configuration is that it is easy and inexpensive to re-run in order to produce more output or to experiment with the ecosystem and physical model settings (Forget 2018, 2019, </span><span class="ot">&lt;https://cbiomes.readthedocs.io&gt;</span><span class="at">). Results here have been interpolated to a 0.5 degree grid.</span></span>
<span id="cb28-474"><a href="#cb28-474"></a></span>
<span id="cb28-475"><a href="#cb28-475"></a>Source: <span class="ot">&lt;https://simonscmap.com/catalog/datasets/Darwin-MITgcm_Climatology&gt;</span></span>
<span id="cb28-476"><a href="#cb28-476"></a></span>
<span id="cb28-477"><a href="#cb28-477"></a>**Note:** This output is the averaged monthly climatology and only includes values averaged over the model's monthly time steps. This model output is small enough that we can download it for the entire ocean, save the product, and access it later if needed</span>
<span id="cb28-478"><a href="#cb28-478"></a></span>
<span id="cb28-479"><a href="#cb28-479"></a><span class="fu">## tblDarwin_Nutrient_Climatology</span></span>
<span id="cb28-480"><a href="#cb28-480"></a></span>
<span id="cb28-481"><a href="#cb28-481"></a>Source: <span class="ot">&lt;https://simonscmap.com/catalog/datasets/Darwin-MITgcm_Climatology&gt;</span></span>
<span id="cb28-482"><a href="#cb28-482"></a></span>
<span id="cb28-483"><a href="#cb28-483"></a><span class="fu">### Download</span></span>
<span id="cb28-484"><a href="#cb28-484"></a></span>
<span id="cb28-487"><a href="#cb28-487"></a><span class="in">```{r}</span></span>
<span id="cb28-488"><a href="#cb28-488"></a><span class="co">#| echo: true</span></span>
<span id="cb28-489"><a href="#cb28-489"></a><span class="co">#| eval: false</span></span>
<span id="cb28-490"><a href="#cb28-490"></a><span class="co">#| output: false</span></span>
<span id="cb28-491"><a href="#cb28-491"></a>tblDarwin_Nutrient_Climatology <span class="ot">&lt;-</span> cmap4r<span class="sc">::</span><span class="fu">get_spacetime</span>(</span>
<span id="cb28-492"><a href="#cb28-492"></a>  <span class="at">tableName =</span> <span class="st">"tblDarwin_Nutrient_Climatology"</span>,</span>
<span id="cb28-493"><a href="#cb28-493"></a>  <span class="at">varName =</span> <span class="st">"*"</span>,</span>
<span id="cb28-494"><a href="#cb28-494"></a>  <span class="at">dt1 =</span> <span class="st">""</span>,</span>
<span id="cb28-495"><a href="#cb28-495"></a>  <span class="at">dt2 =</span> <span class="st">""</span>,</span>
<span id="cb28-496"><a href="#cb28-496"></a>  <span class="at">lat1 =</span> <span class="sc">-</span><span class="dv">90</span>,</span>
<span id="cb28-497"><a href="#cb28-497"></a>  <span class="at">lat2 =</span> <span class="dv">90</span>,</span>
<span id="cb28-498"><a href="#cb28-498"></a>  <span class="at">lon1 =</span> <span class="sc">-</span><span class="dv">180</span>,</span>
<span id="cb28-499"><a href="#cb28-499"></a>  <span class="at">lon2 =</span> <span class="dv">180</span></span>
<span id="cb28-500"><a href="#cb28-500"></a>)</span>
<span id="cb28-501"><a href="#cb28-501"></a></span>
<span id="cb28-502"><a href="#cb28-502"></a>tblDarwin_Nutrient_Climatology <span class="sc">%&gt;%</span> </span>
<span id="cb28-503"><a href="#cb28-503"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">lat_dw =</span> lat, <span class="at">lon_dw =</span> lon, <span class="at">depth_dw =</span> depth) <span class="sc">%&gt;%</span> </span>
<span id="cb28-504"><a href="#cb28-504"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"darwin"</span>, <span class="st">"tblDarwin_Nutrient_Climatology.parquet"</span>))</span>
<span id="cb28-505"><a href="#cb28-505"></a><span class="in">```</span></span>
<span id="cb28-506"><a href="#cb28-506"></a></span>
<span id="cb28-507"><a href="#cb28-507"></a><span class="fu">### Filtering</span></span>
<span id="cb28-508"><a href="#cb28-508"></a></span>
<span id="cb28-509"><a href="#cb28-509"></a>Filtering Darwin output to only closest matching depth. We use the "Tara to Darwin grid mapping" derived earlier. Distance between depths is calculated as the magnitude of their difference.</span>
<span id="cb28-510"><a href="#cb28-510"></a></span>
<span id="cb28-511"><a href="#cb28-511"></a>Something seriously weird is happening - I should be able to join on <span class="in">`depth_dw`</span> variable in both datasets but for some cases NAs are produced when there is not missing data in the Darwin climatology data. <span class="co">[</span><span class="ot">Note issue here</span><span class="co">](https://stackoverflow.com/questions/46487199/r-dplyr-left-join-error-missing-values-produced-when-joining-values-rounded-to)</span> on joining by numbers. Apparently better to convert to string first?</span>
<span id="cb28-512"><a href="#cb28-512"></a></span>
<span id="cb28-513"><a href="#cb28-513"></a>Note: also something weird going on with TARA_206 at depth 411. In the 3-day average Darwin model these values are not missing, but they are missing in the climatology</span>
<span id="cb28-514"><a href="#cb28-514"></a></span>
<span id="cb28-517"><a href="#cb28-517"></a><span class="in">```{r}</span></span>
<span id="cb28-518"><a href="#cb28-518"></a>darwin_tara_grid_map <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"darwin_tara_grid_map.parquet"</span>))</span>
<span id="cb28-519"><a href="#cb28-519"></a></span>
<span id="cb28-520"><a href="#cb28-520"></a><span class="fu">left_join</span>(darwin_tara_grid_map,</span>
<span id="cb28-521"><a href="#cb28-521"></a>          arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"darwin"</span>, <span class="st">"tblDarwin_Nutrient_Climatology.parquet"</span>)),</span>
<span id="cb28-522"><a href="#cb28-522"></a>          <span class="at">by =</span> <span class="fu">join_by</span>(lat_dw, lon_dw),</span>
<span id="cb28-523"><a href="#cb28-523"></a>          <span class="at">relationship =</span> <span class="st">"many-to-many"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-524"><a href="#cb28-524"></a>  <span class="fu">group_by</span>(tara_station, lat_dw, lon_dw, depth_dw.x) <span class="sc">%&gt;%</span> </span>
<span id="cb28-525"><a href="#cb28-525"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(depth_dw.x<span class="sc">-</span>depth_dw.y) <span class="sc">==</span> <span class="fu">min</span>(<span class="fu">abs</span>(depth_dw.x<span class="sc">-</span>depth_dw.y))) <span class="sc">%&gt;%</span> </span>
<span id="cb28-526"><a href="#cb28-526"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-527"><a href="#cb28-527"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(tara2darwin, <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, latitude, longitude, depth, date_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-528"><a href="#cb28-528"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_barcode_num, tara_station, latitude, longitude, depth, date_time, lat_dw, lon_dw, depth_dw.x, time_dw) <span class="sc">%&gt;%</span></span>
<span id="cb28-529"><a href="#cb28-529"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">depth_dw =</span> depth_dw.x) <span class="sc">%&gt;%</span> </span>
<span id="cb28-530"><a href="#cb28-530"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dist_diff_km, <span class="sc">-</span>depth_diff_m, <span class="sc">-</span>time_diff_hr, <span class="sc">-</span>lat1, <span class="sc">-</span>lat2, <span class="sc">-</span>lon1, <span class="sc">-</span>lon2, <span class="sc">-</span>dt1, <span class="sc">-</span>dt2) <span class="sc">%&gt;%</span> </span>
<span id="cb28-531"><a href="#cb28-531"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Nutrient_Climatology_subset_filt.parquet"</span>))</span>
<span id="cb28-532"><a href="#cb28-532"></a><span class="in">```</span></span>
<span id="cb28-533"><a href="#cb28-533"></a></span>
<span id="cb28-534"><a href="#cb28-534"></a><span class="fu">## tblDarwin_Plankton_Climatology</span></span>
<span id="cb28-535"><a href="#cb28-535"></a></span>
<span id="cb28-536"><a href="#cb28-536"></a>Source: <span class="ot">&lt;https://simonscmap.com/catalog/datasets/Darwin-MITgcm_Climatology&gt;</span></span>
<span id="cb28-537"><a href="#cb28-537"></a></span>
<span id="cb28-538"><a href="#cb28-538"></a><span class="fu">### Download</span></span>
<span id="cb28-539"><a href="#cb28-539"></a></span>
<span id="cb28-542"><a href="#cb28-542"></a><span class="in">```{r}</span></span>
<span id="cb28-543"><a href="#cb28-543"></a><span class="co">#| echo: true</span></span>
<span id="cb28-544"><a href="#cb28-544"></a><span class="co">#| eval: false</span></span>
<span id="cb28-545"><a href="#cb28-545"></a><span class="co">#| output: false</span></span>
<span id="cb28-546"><a href="#cb28-546"></a>tblDarwin_Plankton_Climatology <span class="ot">&lt;-</span> cmap4r<span class="sc">::</span><span class="fu">get_spacetime</span>(</span>
<span id="cb28-547"><a href="#cb28-547"></a>  <span class="at">tableName =</span> <span class="st">"tblDarwin_Plankton_Climatology"</span>,</span>
<span id="cb28-548"><a href="#cb28-548"></a>  <span class="at">varName =</span> <span class="st">"*"</span>,</span>
<span id="cb28-549"><a href="#cb28-549"></a>  <span class="at">dt1 =</span> <span class="st">""</span>,</span>
<span id="cb28-550"><a href="#cb28-550"></a>  <span class="at">dt2 =</span> <span class="st">""</span>,</span>
<span id="cb28-551"><a href="#cb28-551"></a>  <span class="at">lat1 =</span> <span class="sc">-</span><span class="dv">90</span>,</span>
<span id="cb28-552"><a href="#cb28-552"></a>  <span class="at">lat2 =</span> <span class="dv">90</span>,</span>
<span id="cb28-553"><a href="#cb28-553"></a>  <span class="at">lon1 =</span> <span class="sc">-</span><span class="dv">180</span>,</span>
<span id="cb28-554"><a href="#cb28-554"></a>  <span class="at">lon2 =</span> <span class="dv">180</span></span>
<span id="cb28-555"><a href="#cb28-555"></a>)</span>
<span id="cb28-556"><a href="#cb28-556"></a></span>
<span id="cb28-557"><a href="#cb28-557"></a>tblDarwin_Plankton_Climatology <span class="sc">%&gt;%</span> </span>
<span id="cb28-558"><a href="#cb28-558"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">lat_dw =</span> lat, <span class="at">lon_dw =</span> lon, <span class="at">depth_dw =</span> depth) <span class="sc">%&gt;%</span> </span>
<span id="cb28-559"><a href="#cb28-559"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"darwin"</span>, <span class="st">"tblDarwin_Plankton_Climatology.parquet"</span>))</span>
<span id="cb28-560"><a href="#cb28-560"></a><span class="in">```</span></span>
<span id="cb28-561"><a href="#cb28-561"></a></span>
<span id="cb28-562"><a href="#cb28-562"></a><span class="fu">### Filtering</span></span>
<span id="cb28-563"><a href="#cb28-563"></a></span>
<span id="cb28-564"><a href="#cb28-564"></a>Filtering Darwin output to only closest matching depth. We use the "Tara to Darwin grid mapping" derived earlier. Distance between depths is calculated as the magnitude of their difference.</span>
<span id="cb28-565"><a href="#cb28-565"></a></span>
<span id="cb28-566"><a href="#cb28-566"></a>Something seriously weird is happening - I should be able to join on <span class="in">`depth_dw`</span> variable in both datasets but for some cases NAs are produced when there is not missing data in the Darwin climatology data. <span class="co">[</span><span class="ot">Note issue here</span><span class="co">](https://stackoverflow.com/questions/46487199/r-dplyr-left-join-error-missing-values-produced-when-joining-values-rounded-to)</span> on joining by numbers. Apparently better to convert to string first?</span>
<span id="cb28-567"><a href="#cb28-567"></a></span>
<span id="cb28-568"><a href="#cb28-568"></a>Note: also something weird going on with TARA_206 at depth 411. In the 3-day average Darwin model these values are not missing, but they are missing in the climatology</span>
<span id="cb28-569"><a href="#cb28-569"></a></span>
<span id="cb28-572"><a href="#cb28-572"></a><span class="in">```{r}</span></span>
<span id="cb28-573"><a href="#cb28-573"></a>darwin_tara_grid_map <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"darwin_tara_grid_map.parquet"</span>))</span>
<span id="cb28-574"><a href="#cb28-574"></a></span>
<span id="cb28-575"><a href="#cb28-575"></a><span class="fu">left_join</span>(darwin_tara_grid_map,</span>
<span id="cb28-576"><a href="#cb28-576"></a>          arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"darwin"</span>, <span class="st">"tblDarwin_Plankton_Climatology.parquet"</span>)),</span>
<span id="cb28-577"><a href="#cb28-577"></a>          <span class="at">by =</span> <span class="fu">join_by</span>(lat_dw, lon_dw),</span>
<span id="cb28-578"><a href="#cb28-578"></a>          <span class="at">relationship =</span> <span class="st">"many-to-many"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-579"><a href="#cb28-579"></a>  <span class="fu">group_by</span>(tara_station, lat_dw, lon_dw, depth_dw.x) <span class="sc">%&gt;%</span> </span>
<span id="cb28-580"><a href="#cb28-580"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(depth_dw.x<span class="sc">-</span>depth_dw.y) <span class="sc">==</span> <span class="fu">min</span>(<span class="fu">abs</span>(depth_dw.x<span class="sc">-</span>depth_dw.y))) <span class="sc">%&gt;%</span> </span>
<span id="cb28-581"><a href="#cb28-581"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-582"><a href="#cb28-582"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(tara2darwin, <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, latitude, longitude, depth, date_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-583"><a href="#cb28-583"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_barcode_num, tara_station, latitude, longitude, depth, date_time, lat_dw, lon_dw, depth_dw.x, time_dw) <span class="sc">%&gt;%</span></span>
<span id="cb28-584"><a href="#cb28-584"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">depth_dw =</span> depth_dw.x) <span class="sc">%&gt;%</span> </span>
<span id="cb28-585"><a href="#cb28-585"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dist_diff_km, <span class="sc">-</span>depth_diff_m, <span class="sc">-</span>time_diff_hr, <span class="sc">-</span>lat1, <span class="sc">-</span>lat2, <span class="sc">-</span>lon1, <span class="sc">-</span>lon2, <span class="sc">-</span>dt1, <span class="sc">-</span>dt2) <span class="sc">%&gt;%</span> </span>
<span id="cb28-586"><a href="#cb28-586"></a>  <span class="co">#filter(if_any(everything(), ~is.na(.)))</span></span>
<span id="cb28-587"><a href="#cb28-587"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Plankton_Climatology_subset_filt.parquet"</span>))</span>
<span id="cb28-588"><a href="#cb28-588"></a><span class="in">```</span></span>
<span id="cb28-589"><a href="#cb28-589"></a></span>
<span id="cb28-590"><a href="#cb28-590"></a><span class="fu">## tblDarwin_Chl_Climatology</span></span>
<span id="cb28-591"><a href="#cb28-591"></a></span>
<span id="cb28-592"><a href="#cb28-592"></a>Source: <span class="ot">&lt;https://simonscmap.com/catalog/datasets/Darwin-MITgcm_Climatology&gt;</span></span>
<span id="cb28-593"><a href="#cb28-593"></a></span>
<span id="cb28-594"><a href="#cb28-594"></a><span class="fu">### Download</span></span>
<span id="cb28-595"><a href="#cb28-595"></a></span>
<span id="cb28-598"><a href="#cb28-598"></a><span class="in">```{r}</span></span>
<span id="cb28-599"><a href="#cb28-599"></a><span class="co">#| echo: true</span></span>
<span id="cb28-600"><a href="#cb28-600"></a><span class="co">#| eval: false</span></span>
<span id="cb28-601"><a href="#cb28-601"></a><span class="co">#| output: false</span></span>
<span id="cb28-602"><a href="#cb28-602"></a>tblDarwin_Chl_Climatology <span class="ot">&lt;-</span> cmap4r<span class="sc">::</span><span class="fu">get_spacetime</span>(</span>
<span id="cb28-603"><a href="#cb28-603"></a>  <span class="at">tableName =</span> <span class="st">"tblDarwin_Chl_Climatology"</span>,</span>
<span id="cb28-604"><a href="#cb28-604"></a>  <span class="at">varName =</span> <span class="st">"*"</span>,</span>
<span id="cb28-605"><a href="#cb28-605"></a>  <span class="at">dt1 =</span> <span class="st">""</span>,</span>
<span id="cb28-606"><a href="#cb28-606"></a>  <span class="at">dt2 =</span> <span class="st">""</span>,</span>
<span id="cb28-607"><a href="#cb28-607"></a>  <span class="at">lat1 =</span> <span class="sc">-</span><span class="dv">90</span>,</span>
<span id="cb28-608"><a href="#cb28-608"></a>  <span class="at">lat2 =</span> <span class="dv">90</span>,</span>
<span id="cb28-609"><a href="#cb28-609"></a>  <span class="at">lon1 =</span> <span class="sc">-</span><span class="dv">180</span>,</span>
<span id="cb28-610"><a href="#cb28-610"></a>  <span class="at">lon2 =</span> <span class="dv">180</span></span>
<span id="cb28-611"><a href="#cb28-611"></a>)</span>
<span id="cb28-612"><a href="#cb28-612"></a></span>
<span id="cb28-613"><a href="#cb28-613"></a>tblDarwin_Chl_Climatology <span class="sc">%&gt;%</span> </span>
<span id="cb28-614"><a href="#cb28-614"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">lat_dw =</span> lat, <span class="at">lon_dw =</span> lon, <span class="at">depth_dw =</span> depth) <span class="sc">%&gt;%</span> </span>
<span id="cb28-615"><a href="#cb28-615"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"darwin"</span>, <span class="st">"tblDarwin_Chl_Climatology.parquet"</span>))</span>
<span id="cb28-616"><a href="#cb28-616"></a><span class="in">```</span></span>
<span id="cb28-617"><a href="#cb28-617"></a></span>
<span id="cb28-618"><a href="#cb28-618"></a><span class="fu">### Filtering</span></span>
<span id="cb28-619"><a href="#cb28-619"></a></span>
<span id="cb28-620"><a href="#cb28-620"></a>Filtering Darwin output to only closest matching depth. We use the "Tara to Darwin grid mapping" derived earlier. Distance between depths is calculated as the magnitude of their difference.</span>
<span id="cb28-621"><a href="#cb28-621"></a></span>
<span id="cb28-622"><a href="#cb28-622"></a>Something seriously weird is happening - I should be able to join on <span class="in">`depth_dw`</span> variable in both datasets but for some cases NAs are produced when there is not missing data in the Darwin climatology data. <span class="co">[</span><span class="ot">Note issue here</span><span class="co">](https://stackoverflow.com/questions/46487199/r-dplyr-left-join-error-missing-values-produced-when-joining-values-rounded-to)</span> on joining by numbers. Apparently better to convert to string first?</span>
<span id="cb28-623"><a href="#cb28-623"></a></span>
<span id="cb28-624"><a href="#cb28-624"></a>Note: also something weird going on with TARA_206 at depth 411. In the 3-day average Darwin model these values are not missing, but they are missing in the climatology</span>
<span id="cb28-625"><a href="#cb28-625"></a></span>
<span id="cb28-628"><a href="#cb28-628"></a><span class="in">```{r}</span></span>
<span id="cb28-629"><a href="#cb28-629"></a>darwin_tara_grid_map <span class="ot">&lt;-</span> arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"darwin_tara_grid_map.parquet"</span>))</span>
<span id="cb28-630"><a href="#cb28-630"></a></span>
<span id="cb28-631"><a href="#cb28-631"></a><span class="fu">left_join</span>(darwin_tara_grid_map,</span>
<span id="cb28-632"><a href="#cb28-632"></a>          arrow<span class="sc">::</span><span class="fu">read_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"_data_raw"</span>, <span class="st">"cmap"</span>, <span class="st">"darwin"</span>, <span class="st">"tblDarwin_Chl_Climatology.parquet"</span>)),</span>
<span id="cb28-633"><a href="#cb28-633"></a>          <span class="at">by =</span> <span class="fu">join_by</span>(lat_dw, lon_dw),</span>
<span id="cb28-634"><a href="#cb28-634"></a>          <span class="at">relationship =</span> <span class="st">"many-to-many"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-635"><a href="#cb28-635"></a>  <span class="fu">group_by</span>(tara_station, lat_dw, lon_dw, depth_dw.x) <span class="sc">%&gt;%</span> </span>
<span id="cb28-636"><a href="#cb28-636"></a>  <span class="fu">filter</span>(<span class="fu">abs</span>(depth_dw.x<span class="sc">-</span>depth_dw.y) <span class="sc">==</span> <span class="fu">min</span>(<span class="fu">abs</span>(depth_dw.x<span class="sc">-</span>depth_dw.y))) <span class="sc">%&gt;%</span> </span>
<span id="cb28-637"><a href="#cb28-637"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-638"><a href="#cb28-638"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(tara2darwin, <span class="at">by =</span> <span class="fu">join_by</span>(tara_station, latitude, longitude, depth, date_time)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-639"><a href="#cb28-639"></a>  dplyr<span class="sc">::</span><span class="fu">relocate</span>(tara_barcode_num, tara_station, latitude, longitude, depth, date_time, lat_dw, lon_dw, depth_dw.x, time_dw) <span class="sc">%&gt;%</span></span>
<span id="cb28-640"><a href="#cb28-640"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">depth_dw =</span> depth_dw.x) <span class="sc">%&gt;%</span> </span>
<span id="cb28-641"><a href="#cb28-641"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>dist_diff_km, <span class="sc">-</span>depth_diff_m, <span class="sc">-</span>time_diff_hr, <span class="sc">-</span>lat1, <span class="sc">-</span>lat2, <span class="sc">-</span>lon1, <span class="sc">-</span>lon2, <span class="sc">-</span>dt1, <span class="sc">-</span>dt2) <span class="sc">%&gt;%</span> </span>
<span id="cb28-642"><a href="#cb28-642"></a>  <span class="co">#filter(if_any(everything(), ~is.na(.)))</span></span>
<span id="cb28-643"><a href="#cb28-643"></a>  arrow<span class="sc">::</span><span class="fu">write_parquet</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"tara"</span>, <span class="st">"darwin_subsets"</span>, <span class="st">"tblDarwin_Chl_Climatology_subset_filt.parquet"</span>))</span>
<span id="cb28-644"><a href="#cb28-644"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>